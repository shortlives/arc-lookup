<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body{
      background:#000; color:#fff; font-family:Segoe UI,sans-serif;
      padding:20px; max-width:980px; margin:0 auto;
    }

    .top-bar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .top-buttons{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .top-buttons a,.top-buttons button{
      background:#222; color:#fff; border:1px solid #444; border-radius:6px;
      padding:6px 12px; font-size:14px; cursor:pointer; text-decoration:none;
    }
    .top-buttons a:hover,.top-buttons button:hover{ background:#333; }

    .status{ font-size:12px; font-weight:bold; white-space:nowrap; }
    .status.loading{ color:#ff5555; }
    .status.loaded{ color:#33cc66; }
    .status.error{ color:#ff9933; }

    .search-row{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    #search{ flex:1; font-size:22px; padding:12px; }
    #clear-search{
      padding:10px 14px; font-size:18px; background:#222; color:#fff;
      border:1px solid #444; border-radius:6px; cursor:pointer;
    }

    .all-filters{
      display:none; gap:8px; flex-wrap:wrap; margin:10px 0 14px 0;
    }
    .all-filters button{
      background:#222; color:#fff; border:1px solid #444;
      border-radius:6px; padding:6px 10px; cursor:pointer;
    }
    .all-filters button.active{ background:#444; }

    .instructions{
      display:none; background:#111; border:1px solid #333;
      border-radius:8px; padding:10px 12px; font-size:13px;
      margin-bottom:12px;
    }

    .item-block{ margin:10px 0 16px 0; }
    .item-title{
      font-size:26px; font-weight:bold;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .item-value{ font-size:20px; }
    .notes{ color:#ff6666; margin:6px 0; }
    .line{ margin:4px 0; font-size:18px; }
    .line-small{ font-size:14px; color:#ccc; }
    .btn-small{
      background:#222; color:#fff; border:1px solid #444;
      border-radius:6px; padding:4px 10px; cursor:pointer;
    }
    hr{ border:1px solid #333; margin:10px 0; }

    .section-header{
      font-size:24px; font-weight:bold;
      margin:18px 0 6px 0;
      border-bottom:1px solid #333;
      padding-bottom:4px;
    }
    .craft-row{ margin-left:10px; }
    .craft-level{ color:#ffd700; margin-left:6px; }
  </style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit?gid=491619272"
       target="_blank">Spreadsheet</a>
    <button id="workshopsBtn">Workshops</button>
    <button id="showAllBtn">Show All (High → Low)</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…" autofocus>
  <button id="clear-search">×</button>
</div>

<div class="all-filters" id="allFilters">
  <button data-filter="all" class="active">All</button>
  <button data-filter="__other__">Everything else</button>
  <button data-filter="Weapon">Weapon</button>
  <button data-filter="Modification">Modification</button>
  <button data-filter="Blueprint">Blueprint</button>
  <button data-filter="Key">Key</button>
  <button data-filter="Quest Item">Quest Item</button>
  <button data-filter="Misc">Misc</button>
</div>

<div class="instructions" id="instructions">
  <strong>Type to search items. Click “Workshops” to browse crafting.</strong>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-15
   - FIXED: Header normalization regression.
   - RESTORED: Spreadsheet button and full item info.
   - ADDED: Filters and Everything Else category.

   2025-12-16
   - ADDED: Crafting system (separate from recycling).
   - ADDED: Workshops view grouped by "Crafted At".
   - ADDED: Reverse crafting lookup ("Crafts To") on item pages.
   - DESIGN: Crafting treated as first-class data, not inferred.
*/

/* ============================================================
   CONFIG
   ============================================================ */
const ITEMS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ============================================================
   DOM
   ============================================================ */
const dom = {
  status: document.getElementById("status"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  showAll: document.getElementById("showAllBtn"),
  workshops: document.getElementById("workshopsBtn"),
  filters: document.getElementById("allFilters"),
  instructions: document.getElementById("instructions"),
  result: document.getElementById("result")
};

/* ============================================================
   STATE
   ============================================================ */
const state = {
  items: [],
  crafting: [],
  craftsByIngredient: new Map(),
  viewMode: "search", // search | all | workshops
  activeFilter: "all",
  expandedNames: new Set(),
  knownTypes: new Set(["weapon","modification","blueprint","key","quest item","misc"])
};

/* ============================================================
   HELPERS
   ============================================================ */
function canon(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]/g,""); }
function norm(s){ return (s||"").trim().toLowerCase(); }

function parseCsv(text){
  const rows=[]; let row=[], field="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'&&q&&n==='"'){ field+='"'; i++; }
    else if(c==='"'){ q=!q; }
    else if(c===','&&!q){ row.push(field); field=""; }
    else if((c==='\n'||c==='\r')&&!q){
      if(row.length||field) rows.push([...row,field]);
      row=[]; field="";
    } else field+=c;
  }
  if(row.length||field) rows.push([...row,field]);
  return rows;
}

function parseQtyName(entry){
  if(!entry) return null;
  const m=entry.trim().match(/^(\d+)\s*x?\s*(.+)$/i);
  return m ? {qty:+m[1], name:m[2].trim()} : {qty:null,name:entry.trim()};
}

/* ============================================================
   LOADERS
   ============================================================ */
async function loadCsv(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("CSV load failed");
  return parseCsv(await r.text());
}

async function loadItems(){
  const rows=await loadCsv(ITEMS_CSV);
  const headers=rows.shift().map(canon);
  rows.shift(); // config row

  const idx=h=>headers.indexOf(canon(h));

  state.items=rows.filter(r=>r[idx("name")]).map(r=>({
    name:r[idx("name")],
    nameKey:norm(r[idx("name")]),
    value:+(r[idx("value")]||0),
    itemType:r[idx("itemtype")]||"",
    recycle:[r[idx("recycle1")],r[idx("recycle2")]].filter(Boolean),
    salvage:[r[idx("salvage1")],r[idx("salvage2")]].filter(Boolean)
  }));
}

async function loadCrafting(){
  const rows=await loadCsv(CRAFTING_CSV);
  const headers=rows.shift().map(canon);

  const idx=h=>headers.indexOf(canon(h));

  state.crafting=[];
  state.craftsByIngredient.clear();

  for(const r of rows){
    const crafted=r[idx("itemcrafted")];
    if(!crafted) continue;

    const ingredients=[1,2,3]
      .map(n=>r[idx(`ingredient${n}`)])
      .filter(Boolean)
      .map(parseQtyName);

    const row={
      crafted,
      category:r[idx("category")]||"",
      at:r[idx("craftedat")]||"",
      level:r[idx("level")]||"",
      ingredients
    };
    state.crafting.push(row);

    for(const ing of ingredients){
      const k=norm(ing.name);
      if(!state.craftsByIngredient.has(k))
        state.craftsByIngredient.set(k,[]);
      state.craftsByIngredient.get(k).push(row);
    }
  }
}

/* ============================================================
   RENDERING
   ============================================================ */
function renderCraftsTo(item){
  const list=state.craftsByIngredient.get(item.nameKey);
  if(!list||!list.length) return "";
  return `<div class="line"><strong>Crafts To:</strong> ${
    list.map(c=>c.crafted).join(", ")
  }</div>`;
}

function renderWorkshops(){
  dom.result.innerHTML="";
  const groups={};
  for(const c of state.crafting){
    if(!groups[c.at]) groups[c.at]=[];
    groups[c.at].push(c);
  }

  for(const at of Object.keys(groups)){
    dom.result.insertAdjacentHTML("beforeend",
      `<div class="section-header">${at}</div>`
    );
    for(const c of groups[at]){
      dom.result.insertAdjacentHTML("beforeend",`
        <div class="craft-row line">
          <strong>${c.crafted}</strong> — ${c.category}
          · ${c.ingredients.map(i=>`${i.name} ×${i.qty||1}`).join(", ")}
          ${c.level?`<span class="craft-level">Workshop Level ${c.level}</span>`:""}
        </div>
      `);
    }
  }
}

/* ============================================================
   EVENTS
   ============================================================ */
dom.workshops.onclick=async()=>{
  state.viewMode="workshops";
  dom.search.value="";
  dom.filters.style.display="none";
  dom.instructions.style.display="none";
  renderWorkshops();
};

dom.search.oninput=()=>{
  state.viewMode="search";
  dom.instructions.style.display="block";
  dom.result.innerHTML="";
};

dom.showAll.onclick=()=>{
  state.viewMode="all";
  dom.filters.style.display="flex";
};

/* ============================================================
   BOOT
   ============================================================ */
(async()=>{
  try{
    await loadItems();
    await loadCrafting();
    dom.status.textContent="Loaded";
    dom.status.className="status loaded";
  }catch(e){
    console.error(e);
    dom.status.textContent="Error loading data";
    dom.status.className="status error";
  }
})();
</script>

</body>
</html>
