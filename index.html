<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>

<script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

<style>
body{background:#000;color:#fff;font-family:Segoe UI,sans-serif;padding:20px;max-width:1100px;margin:0 auto}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.top-buttons{display:flex;gap:10px;flex-wrap:wrap}
.top-buttons a,.top-buttons button{
  background:#222;color:#fff;border:1px solid #444;border-radius:6px;
  padding:6px 12px;cursor:pointer;text-decoration:none
}
.top-buttons a:hover,.top-buttons button:hover{background:#333}
.status.loading{color:#ff5555}.status.loaded{color:#33cc66}.status.error{color:#ff9933}

.search-row{display:flex;gap:8px;margin-bottom:8px}
#search{flex:1;font-size:22px;padding:12px}
#clear-search{padding:10px 14px;font-size:18px}

.all-filters{display:none;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.all-filters button{
  background:#222;color:#fff;border:1px solid #444;border-radius:6px;
  padding:6px 10px;cursor:pointer
}
.all-filters button.active{background:#444}

.item-block{margin:12px 0 18px}
.item-title{font-size:26px;font-weight:bold;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.item-title a{text-decoration:none}
.item-value{font-size:20px}
.btn-small{
  background:#222;border:1px solid #444;color:#fff;
  border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer
}
.notes{color:#ff6666;margin:6px 0}
.line{margin:4px 0;font-size:18px}
.line-small{font-size:14px;color:#ccc}
.quest-tag{color:#ffd700;margin-left:6px}
hr{border:1px solid #333;margin:12px 0}

.section-header{
  font-size:24px;font-weight:bold;margin-top:24px;
  border-bottom:1px solid #444;padding-bottom:6px
}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #333;padding:10px;vertical-align:top}
th{color:#ffd700;text-align:left}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit" target="_blank">Spreadsheet</a>
    <button id="workshopsBtn">Workshops</button>
    <button id="showAllBtn">Show All</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<div class="all-filters" id="filters">
  <button data-filter="__other__" class="active">Everything else</button>
  <button data-filter="Weapon">Weapon</button>
  <button data-filter="Modification">Modification</button>
  <button data-filter="Blueprint">Blueprint</button>
  <button data-filter="Key">Key</button>
  <button data-filter="Quest Item">Quest Item</button>
  <button data-filter="all">All (High → Low)</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-15
   - Header normalization fixed.
   - Full item info restored.

   2025-12-16
   - Added crafting system and workshops.

   2025-12-17
   - Fixed Show All rendering regression.
   - Restored filter pipeline.
   - Restored Full Info toggle render path.

   2025-12-18
   - Moved "Everything else" to leftmost filter and made it default.
   - Moved "All (High → Low)" to the far right.
   - Fixed Full Info toggle logic.
   - Fully restored Workshops rendering.
*/

/* ================= CONFIG ================= */
const ITEMS_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ================= STATE ================= */
const state={
  items:[],
  crafting:[],
  craftsByIngredient:new Map(),
  expanded:new Set(),
  view:"search",
  filter:"__other__"
};

/* ================= DOM ================= */
const dom={
  result:document.getElementById("result"),
  search:document.getElementById("search"),
  clear:document.getElementById("clear-search"),
  status:document.getElementById("status"),
  showAll:document.getElementById("showAllBtn"),
  workshops:document.getElementById("workshopsBtn"),
  filters:document.getElementById("filters")
};

/* ================= HELPERS ================= */
const canon=s=>(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
const norm=s=>(s||"").trim().toLowerCase();

function rarityColor(r){
  r=(r||"").toLowerCase();
  if(r.includes("legendary"))return"#ffd700";
  if(r.includes("epic"))return"#ff00ff";
  if(r.includes("rare"))return"#00bfff";
  if(r.includes("uncommon"))return"#00ff00";
  return"#fff";
}
function priceColor(v){
  v=+v||0;
  if(v<=1000)return"#fff";
  if(v<=2000)return"#00ff00";
  if(v<=5000)return"#ff69b4";
  return"#ffd700";
}

/* ================= CSV ================= */
function parseCsv(t){
  const r=[];let row=[],f="",q=false;
  for(let i=0;i<t.length;i++){
    const c=t[i],n=t[i+1];
    if(c=='"'&&q&&n=='"'){f+='"';i++}
    else if(c=='"')q=!q;
    else if(c==","&&!q){row.push(f);f=""}
    else if((c=="\n"||c=="\r")&&!q){
      if(row.length||f)r.push([...row,f]);
      row=[];f=""
    }else f+=c
  }
  if(row.length||f)r.push([...row,f]);
  return r
}

/* ================= LOADERS ================= */
async function loadCsv(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok)throw new Error("CSV load failed");
  return parseCsv(await r.text())
}

async function loadItems(){
  const rows=await loadCsv(ITEMS_CSV);
  const headers=rows.shift().map(canon);
  rows.shift();
  const idx=h=>headers.indexOf(canon(h));

  state.items=rows.filter(r=>r[idx("name")]).map(r=>({
    name:r[idx("name")],
    key:norm(r[idx("name")]),
    value:r[idx("value")]||"",
    rarity:r[idx("rarity")]||"",
    apiId:r[idx("apiid")]||"",
    itemType:r[idx("itemtype")]||"",
    notes:r[idx("notes")]||"",
    recycle:[r[idx("recycle1")],r[idx("recycle2")]].filter(Boolean),
    salvage:[r[idx("salvage1")],r[idx("salvage2")]].filter(Boolean),
    quest:[r[idx("quest1")],r[idx("quest2")],r[idx("quest3")]].filter(Boolean)
  }));
}

async function loadCrafting(){
  const rows=await loadCsv(CRAFTING_CSV);
  const headers=rows.shift().map(canon);
  const idx=h=>headers.indexOf(canon(h));

  state.crafting=[];
  state.craftsByIngredient.clear();

  for(const r of rows){
    const crafted=r[idx("itemcrafted")];
    if(!crafted)continue;

    const row={
      crafted,
      category:r[idx("category")]||"",
      at:r[idx("craftedat")]||"",
      level:r[idx("level")]||"",
      ingredients:[1,2,3].map(n=>r[idx(`ingredient${n}`)]).filter(Boolean)
    };
    state.crafting.push(row);

    for(const ing of row.ingredients){
      const key=norm(ing.replace(/×.*$/,""));
      if(!state.craftsByIngredient.has(key))
        state.craftsByIngredient.set(key,[]);
      state.craftsByIngredient.get(key).push(crafted);
    }
  }
}

/* ================= RENDER ================= */
function renderItem(it){
  const expanded=state.expanded.has(it.key);
  const crafts=state.craftsByIngredient.get(it.key)||[];

  let html=`
  <div class="item-block">
    <div class="item-title">
      ${it.apiId
        ? `<a href="https://metaforge.app/arc-raiders/database/item/${it.apiId}" target="_blank">
            <span style="color:${rarityColor(it.rarity)}">${it.name}</span>
          </a>`
        : `<span style="color:${rarityColor(it.rarity)}">${it.name}</span>`
      }
      ${it.value?`<span class="item-value" style="color:${priceColor(it.value)}">— ${it.value}</span>`:""}
      ${it.quest.length?`<span class="quest-tag">[${it.quest.join(", ")}]</span>`:""}
      <button class="btn-small" data-toggle="${it.key}">${expanded?"Hide":"Full"} Info</button>
    </div>`;

  if(expanded){
    if(it.notes) html+=`<div class="notes"><strong>Notes:</strong> ${it.notes}</div>`;
    if(it.recycle.length) html+=`<div class="line"><strong>Recycles To:</strong> ${it.recycle.join(", ")}</div>`;
    if(it.salvage.length) html+=`<div class="line"><strong>Salvages To:</strong> ${it.salvage.join(", ")}</div>`;
    if(crafts.length) html+=`<div class="line"><strong>Crafts To:</strong> ${crafts.join(", ")}</div>`;
  }

  html+=`<hr></div>`;
  return html;
}

function renderList(list){
  dom.result.innerHTML=list.map(renderItem).join("");
}

function renderSearch(q){
  renderList(state.items.filter(i=>i.key.includes(q)));
}

function renderAll(){
  let list=[...state.items];
  if(state.filter!=="all"){
    list=list.filter(i=>{
      if(state.filter==="__other__"){
        return !["weapon","modification","blueprint","key","quest item","misc"].includes(i.itemType.toLowerCase())
      }
      return i.itemType===state.filter
    });
  }
  list.sort((a,b)=>(+b.value||0)-(+a.value||0));
  renderList(list);
}

function renderWorkshops(){
  dom.filters.style.display="none";
  dom.result.innerHTML="";
  const groups={};

  for(const c of state.crafting){
    if(!groups[c.at]) groups[c.at]=[];
    groups[c.at].push(c);
  }

  for(const at of Object.keys(groups)){
    dom.result.insertAdjacentHTML("beforeend",`
      <div class="section-header">${at}</div>
      <table>
        <tr>
          <th>Item Crafted</th>
          <th>Category</th>
          <th>Ingredients</th>
          <th>Workshop Level</th>
        </tr>
        ${groups[at].map(c=>`
          <tr>
            <td>${c.crafted}</td>
            <td>${c.category}</td>
            <td>${c.ingredients.join(", ")}</td>
            <td>${c.level||""}</td>
          </tr>`).join("")}
      </table>
    `);
  }
}

/* ================= EVENTS ================= */
dom.search.oninput=()=>{
  state.view="search";
  dom.filters.style.display="none";
  renderSearch(norm(dom.search.value));
};

dom.clear.onclick=()=>{dom.search.value="";dom.result.innerHTML=""};

dom.showAll.onclick=()=>{
  state.view="all";
  state.filter="__other__";
  dom.filters.style.display="flex";
  dom.filters.querySelectorAll("button").forEach(b=>{
    b.classList.toggle("active",b.dataset.filter==="__other__")
  });
  renderAll();
};

dom.filters.onclick=e=>{
  const b=e.target.closest("button[data-filter]");
  if(!b)return;
  dom.filters.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  state.filter=b.dataset.filter;
  renderAll();
};

dom.result.onclick=e=>{
  const b=e.target.closest("button[data-toggle]");
  if(!b)return;
  const k=b.dataset.toggle;
  state.expanded.has(k)?state.expanded.delete(k):state.expanded.add(k);
  state.view==="all"?renderAll():renderSearch(norm(dom.search.value));
};

dom.workshops.onclick=()=>{
  state.view="workshops";
  renderWorkshops();
};

/* ================= BOOT ================= */
(async()=>{
  try{
    await loadItems();
    await loadCrafting();
    dom.status.textContent="Loaded";
    dom.status.className="status loaded";
  }catch(e){
    console.error(e);
    dom.status.textContent="ERROR";
    dom.status.className="status error";
  }
})();
</script>

</body>
</html>
