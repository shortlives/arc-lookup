<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Segoe UI, sans-serif;
      padding:20px;
      max-width:980px;
      margin:0 auto;
    }

    /* ================= TOP BAR ================= */
    .top-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .top-buttons {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .top-buttons a,
    .top-buttons button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 12px;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
    }
    .top-buttons a:hover,
    .top-buttons button:hover { background:#333; }

    .status {
      font-size:12px;
      font-weight:bold;
      white-space:nowrap;
    }
    .status.loading { color:#ff5555; }
    .status.loaded  { color:#33cc66; }
    .status.warn    { color:#ffcc66; }
    .status.error   { color:#ff9933; }

    /* ================= SEARCH ================= */
    .search-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }

    #search {
      flex:1;
      font-size:22px;
      padding:12px;
    }

    #clear-search {
      padding:10px 14px;
      font-size:18px;
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      cursor:pointer;
    }
    #clear-search:hover { background:#333; }

    /* ================= FILTERS ================= */
    .filters {
      display:none;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 14px 0;
    }

    .filters button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
    }

    .filters button.active {
      background:#444;
      border-color:#888;
    }

    /* ================= ITEMS ================= */
    .item-block { margin:10px 0 16px 0; }

    .item-title {
      font-size:26px;
      font-weight:bold;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .item-title a { text-decoration:none; }
    .item-value { font-size:20px; }

    .btn-small {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .notes {
      color:#ff6666;
      margin:6px 0;
      font-size:16px;
    }

    .line { margin:4px 0; font-size:18px; }
    .line-small { font-size:14px; color:#ccc; }

    .rarity-prefix {
      display:inline-block;
      width:18px;
      text-align:center;
      margin-right:6px;
      font-weight:bold;
    }

    .quest-tag {
      color:#ffd700;
      font-size:16px;
      margin-left:6px;
    }

    hr { border:1px solid #333; margin:10px 0; }
    .muted { color:#aaa; }
  </style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit"
       target="_blank">Spreadsheet</a>
    <button id="showAllBtn">Show All (High → Low)</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<!-- Filters shown ONLY in Show All -->
<div class="filters" id="filters">
  <button data-cat="__other__" class="active">Everything else</button>
  <button data-cat="weapon">Weapon</button>
  <button data-cat="modification">Modification</button>
  <button data-cat="blueprint">Blueprint</button>
  <button data-cat="key">Key</button>
  <button data-cat="quest item">Quest Item</button>
  <button data-cat="misc">Misc</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE)
   ============================================================
   2025-12-15
   - Fixed missing item info rendering.
     Reason: earlier refactor only rendered title/value; restored full card renderer.
   - Fixed category filters returning empty results.
     Reason: ItemType comparisons were case/whitespace sensitive.
     Solution: normalize itemType + filter keys.
   - Renamed "All" filter to "Everything else".
     Behavior: shows items not matching any explicit category buttons.
   - Refactored filtering/rendering into reusable helpers.
     Reason: DRY, easier to reason about UI state transitions.
   - Preserved CSV export tab usage + chunked rendering.
*/

/* ================= CONFIG ================= */
const ITEMS_MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

/* ================= DOM ================= */
const dom = {
  status: document.getElementById("status"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  showAll: document.getElementById("showAllBtn"),
  filters: document.getElementById("filters"),
  result: document.getElementById("result")
};

/* ================= STATE ================= */
const state = {
  items: [],
  view: "search",        // search | all
  activeCategory: "__other__",
  expanded: new Set()
};

/* ================= CSV ================= */
function parseCsv(text) {
  const rows = [];
  let row = [], field = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];
    if (c === '"' && inQuotes && n === '"') { field += '"'; i++; }
    else if (c === '"') inQuotes = !inQuotes;
    else if (c === "," && !inQuotes) { row.push(field); field = ""; }
    else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (row.length || field) rows.push([...row, field]);
      row = []; field = "";
    } else field += c;
  }
  if (row.length || field) rows.push([...row, field]);
  return rows;
}

/* ================= LOAD ================= */
async function loadItems() {
  const res = await fetch(ITEMS_MASTER_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV fetch failed");

  const rows = parseCsv(await res.text());
  const headers = rows.shift().map(h => h.toLowerCase().trim());
  rows.shift(); // config row

  const idx = h => headers.indexOf(h);

  state.items = rows
    .filter(r => r[idx("name")])
    .filter(r => (r[idx("enabled")] || "").toLowerCase() !== "false")
    .map(r => ({
      name: r[idx("name")],
      nameKey: r[idx("name")].toLowerCase(),
      rarity: r[idx("rarity")],
      value: Number(r[idx("value")] || 0),
      apiId: r[idx("apiid")],
      itemType: normalizeType(r[idx("itemtype")]),
      notes: r[idx("notes")] || "",
      recycle1: r[idx("recycle1")] || "",
      recycle2: r[idx("recycle2")] || "",
      salvage1: r[idx("salvage1")] || "",
      salvage2: r[idx("salvage2")] || ""
    }));
}

/* ================= NORMALIZATION ================= */
function normalizeType(v) {
  return (v || "").trim().toLowerCase();
}

/* ================= COLORS ================= */
function rarityColor(r) {
  r = (r || "").toLowerCase();
  if (r.includes("legendary")) return "#ffd700";
  if (r.includes("epic")) return "#ff00ff";
  if (r.includes("rare")) return "#00bfff";
  if (r.includes("uncommon")) return "#00ff00";
  return "#ffffff";
}

/* ================= FILTERING ================= */
const KNOWN_CATEGORIES = ["weapon","modification","blueprint","key","quest item","misc"];

function filterByCategory(items) {
  if (state.activeCategory === "__other__") {
    return items.filter(it => !KNOWN_CATEGORIES.includes(it.itemType));
  }
  return items.filter(it => it.itemType === state.activeCategory);
}

/* ================= ITEM CARD ================= */
function renderItemCard(it) {
  let html = `<div class="item-block">
    <div class="item-title">
      <a href="https://metaforge.app/arc-raiders/database/item/${encodeURIComponent(it.apiId)}" target="_blank">
        <span style="color:${rarityColor(it.rarity)}">${it.name}</span>
      </a>
      <span class="item-value">— ${it.value}</span>
      <button class="btn-small" data-toggle="${it.nameKey}">Full Info</button>
    </div>`;

  if (it.notes) {
    html += `<div class="notes"><strong>Notes:</strong> ${it.notes}</div>`;
  }

  const rec = [it.recycle1, it.recycle2].filter(Boolean);
  if (rec.length) {
    html += `<div class="line"><strong>Recycles To:</strong> ${rec.join(", ")}</div>`;
  }

  const salv = [it.salvage1, it.salvage2].filter(Boolean);
  if (salv.length) {
    html += `<div class="line"><strong>Salvages To:</strong> ${salv.join(", ")}</div>`;
  }

  html += `<hr></div>`;
  return html;
}

/* ================= RENDER ================= */
function getVisibleItems() {
  let list = [...state.items];

  if (state.view === "search") {
    const q = dom.search.value.trim().toLowerCase();
    if (!q) return [];
    list = list.filter(it => it.nameKey.includes(q));
  }

  if (state.view === "all") {
    list.sort((a,b) => b.value - a.value);
    list = filterByCategory(list);
  }

  return list;
}

function renderListChunked(items, batch = 25) {
  dom.result.innerHTML = "";
  let i = 0;

  function chunk() {
    let html = "";
    for (let end = Math.min(i + batch, items.length); i < end; i++) {
      html += renderItemCard(items[i]);
    }
    dom.result.insertAdjacentHTML("beforeend", html);
    if (i < items.length) requestAnimationFrame(chunk);
  }

  if (!items.length) {
    dom.result.innerHTML = `<div class="line">No match</div>`;
    return;
  }

  requestAnimationFrame(chunk);
}

function render() {
  renderListChunked(getVisibleItems());
}

/* ================= EVENTS ================= */
dom.search.addEventListener("input", () => {
  state.view = "search";
  dom.filters.style.display = "none";
  render();
});

dom.clear.addEventListener("click", () => {
  dom.search.value = "";
  dom.result.innerHTML = "";
});

dom.showAll.addEventListener("click", () => {
  state.view = "all";
  state.activeCategory = "__other__";
  dom.search.value = "";
  dom.filters.style.display = "flex";
  [...dom.filters.children].forEach(b => b.classList.remove("active"));
  dom.filters.children[0].classList.add("active");
  render();
});

dom.filters.addEventListener("click", e => {
  const btn = e.target.closest("button[data-cat]");
  if (!btn) return;
  state.activeCategory = btn.dataset.cat;
  [...dom.filters.children].forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  render();
});

/* ================= BOOT ================= */
(async function init() {
  try {
    await loadItems();
    dom.status.textContent = "Loaded";
    dom.status.className = "status loaded";
  } catch (e) {
    console.error(e);
    dom.status.textContent = "Error loading data";
    dom.status.className = "status error";
  }
})();
</script>

</body>
</html>
