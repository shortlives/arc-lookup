<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>

<!-- MetaForge tooltips (unchanged) -->
<script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

<style>
  body {
    background:#000;
    color:#fff;
    font-family:Segoe UI, sans-serif;
    padding:20px;
    max-width:900px;
    margin:0 auto;
  }

  /* ================= TOP BAR ================= */

  .top-bar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }

  .top-buttons {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .top-buttons a,
  .top-buttons button {
    background:#222;
    color:#fff;
    border:1px solid #444;
    border-radius:6px;
    padding:6px 12px;
    font-size:14px;
    cursor:pointer;
    text-decoration:none;
  }

  .status {
    font-size:12px;
    font-weight:bold;
  }
  .loading { color:#ff5555; }
  .loaded  { color:#33cc66; }
  .error   { color:#ff9933; }

  /* ================= SEARCH ================= */

  .search-row {
    display:flex;
    gap:8px;
    margin-bottom:10px;
  }

  #search {
    flex:1;
    font-size:22px;
    padding:12px;
  }

  #clear-search {
    padding:10px 14px;
    font-size:18px;
    background:#222;
    color:#fff;
    border:1px solid #444;
    border-radius:6px;
    cursor:pointer;
  }

  /* ================= ITEMS ================= */

  .item {
    margin-bottom:16px;
  }

  .item-title {
    font-size:26px;
    font-weight:bold;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .item-title a {
    text-decoration:none;
  }

  .value {
    font-size:20px;
  }

  .notes {
    color:#ff6666;
    margin:6px 0;
  }

  .line {
    margin:4px 0;
    font-size:18px;
  }

  hr {
    border:1px solid #333;
    margin:10px 0;
  }
</style>
</head>

<body>

<!-- ================= UI ================= -->

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit?gid=491619272"
       target="_blank">Spreadsheet</a>
    <button id="showAllBtn">Show All (High → Low)</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CONFIG
   ============================================================ */

const ITEMS_MASTER_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=491619272&single=true&output=csv";

/* ============================================================
   STATE
   ============================================================ */

const state = {
  items: [],
  headers: [],
  config: {},   // column -> config value (row 2)
  colIndex: {},
  loaded: false
};

/* ============================================================
   ROBUST CSV PARSER (RFC-4180 style)
   ============================================================ */

function parseCsv(text) {
  const rows = [];
  let row = [];
  let field = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const n = text[i + 1];

    if (c === '"' && inQuotes && n === '"') {
      field += '"';
      i++;
    } else if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      row.push(field);
      field = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (field || row.length) {
        row.push(field);
        rows.push(row);
        row = [];
        field = "";
      }
    } else {
      field += c;
    }
  }

  if (field || row.length) {
    row.push(field);
    rows.push(row);
  }

  return rows;
}

/* ============================================================
   UTILS
   ============================================================ */

function canon(str) {
  return str.toLowerCase().replace(/[^a-z0-9]/g,"");
}

function rarityColor(r) {
  r = (r || "").toLowerCase();
  if (r.includes("legendary")) return "#ffd700";
  if (r.includes("epic"))      return "#ff00ff";
  if (r.includes("rare"))      return "#00bfff";
  if (r.includes("uncommon"))  return "#00ff00";
  return "#ffffff";
}

function priceColor(v) {
  if (v <= 1000) return "#ffffff";
  if (v <= 2000) return "#00ff00";
  if (v <= 5000) return "#ff69b4";
  return "#ffd700";
}

/**
 * Decides whether a field should render:
 *  - Column must be enabled in CONFIG row
 *  - Value must not be empty or zero
 */
function shouldRenderField(colName, rawValue) {
  const cfg = state.config[colName];
  if (!cfg || cfg.toLowerCase() !== "show") return false;

  if (rawValue === null || rawValue === undefined) return false;

  const v = String(rawValue).trim();
  if (v === "" || v === "0") return false;

  return true;
}

/* ============================================================
   DATA LOADING
   ============================================================ */

async function loadData() {
  try {
    const res = await fetch(ITEMS_MASTER_CSV);
    const text = await res.text();

    const rows = parseCsv(text);

    /* Row 1 = headers */
    const headers = rows.shift().map(h => h.trim());
    state.headers = headers;

    /* Row 2 = CONFIG */
    const configRow = rows.shift();
    headers.forEach((h,i) => {
      state.config[h] = (configRow[i] || "").trim();
      state.colIndex[canon(h)] = i;
    });

    /* Remaining rows = ITEMS */
    for (const r of rows) {
      const name = r[state.colIndex.name];
      if (!name) continue;

      const enabledRaw = (r[state.colIndex.enabled] || "").toLowerCase();
      if (["false","0","no"].includes(enabledRaw)) continue;

      const valueRaw = r[state.colIndex.value] || "";
      const valueNum = Number(valueRaw.replace(/,/g,"")) || 0;

      state.items.push({
        name,
        apiId: r[state.colIndex.apiid] || "",
        rarity: r[state.colIndex.rarity] || "",
        valueNum,
        valueRaw,
        row: r
      });
    }

    state.loaded = true;
    const status = document.getElementById("status");
    status.textContent = "Loaded";
    status.className = "status loaded";
    setTimeout(() => status.textContent = "", 5000);

  } catch (err) {
    console.error(err);
    const status = document.getElementById("status");
    status.textContent = "Error loading data";
    status.className = "status error";
  }
}

/* ============================================================
   RENDERING
   ============================================================ */

function renderItems(items) {
  const out = document.getElementById("result");
  out.innerHTML = "";

  for (const it of items) {
    const div = document.createElement("div");
    div.className = "item";

    const link = it.apiId
      ? `<a href="https://metaforge.app/arc-raiders/database/item/${it.apiId}" target="_blank"
            style="color:${rarityColor(it.rarity)}">${it.name}</a>`
      : `<span style="color:${rarityColor(it.rarity)}">${it.name}</span>`;

    let html = `
      <div class="item-title">
        ${link}
        <span class="value" style="color:${priceColor(it.valueNum)}">
          ${it.valueRaw || it.valueNum}
        </span>
      </div>
    `;

    const notes = it.row[state.colIndex.notes];
    if (shouldRenderField("notes", notes)) {
      html += `<div class="notes"><strong>Notes:</strong> ${notes}</div>`;
    }

    for (let i = 0; i < state.headers.length; i++) {
      const col = state.headers[i];
      if (["api_id","name","rarity","value","notes","enabled"].includes(col)) continue;

      const raw = it.row[i];
      if (!shouldRenderField(col, raw)) continue;

      html += `<div class="line"><strong>${col}:</strong> ${raw}</div>`;
    }

    html += "<hr>";
    div.innerHTML = html;
    out.appendChild(div);
  }
}

/* ============================================================
   UI EVENTS
   ============================================================ */

document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase().trim();
  if (!q) {
    document.getElementById("result").innerHTML = "";
    return;
  }
  renderItems(state.items.filter(i => i.name.toLowerCase().includes(q)));
});

document.getElementById("clear-search").onclick = () => {
  document.getElementById("search").value = "";
  document.getElementById("result").innerHTML = "";
};

document.getElementById("showAllBtn").onclick = () => {
  renderItems([...state.items].sort((a,b) => b.valueNum - a.valueNum));
};

/* ============================================================
   BOOT
   ============================================================ */

loadData();
</script>

</body>
</html>
