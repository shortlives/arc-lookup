<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- (Optional, when you want MetaForge tooltips)
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>
  -->

  <style>
    /* -------- Base layout -------- */
    body {
      background: #000;
      color: #fff;
      font-family: Segoe UI, system-ui, -apple-system, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    /* -------- Top nav buttons (Maps, Sheet, Important Notes) -------- */
    .top-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .top-buttons a,
    .top-buttons button {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
    }

    .top-buttons a:hover,
    .top-buttons button:hover {
      background: #333;
    }

    .hidden {
      display: none !important;
    }

    /* -------- Search row (input + X button) -------- */
    .search-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    #search {
      font-size: 22px;
      padding: 12px;
      flex: 1;
      border-radius: 6px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
    }

    #search::placeholder {
      color: #777;
    }

    #clear-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
    }

    #clear-btn:hover {
      background: #333;
    }

    /* -------- Legend / instructions -------- */
    .legend {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .legend-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .legend-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .legend-row strong {
      margin-right: 4px;
    }

    .legend-chip {
      padding: 2px 6px;
      border-radius: 4px;
      background: #222;
      font-size: 13px;
    }

    /* Rarity colors in legend */
    .legend-rarity-uncommon { color: #00ff00; }  /* Uncommon */
    .legend-rarity-rare     { color: #1e90ff; }  /* Rare */
    .legend-rarity-epic     { color: #ff00ff; }  /* Epic */
    .legend-rarity-legendary{ color: #ffd700; }  /* Legendary */

    /* Price colors in legend (based on numeric value) */
    .legend-price-low       { color: #ffffff; }  /* 0–1000 */
    .legend-price-uncommon  { color: #00ff00; }  /* 1001–2000 */
    .legend-price-mid       { color: #ff69b4; }  /* 2001–5000 */
    .legend-price-high      { color: #ffd700; }  /* 5001+ */

    /* -------- Important Notes panel -------- */
    .notes-panel {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .notes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-weight: bold;
    }

    .notes-title {
      font-size: 15px;
    }

    .notes-close-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
    }

    .notes-close-btn:hover {
      background: #333;
    }

    .notes-list {
      margin: 0;
      padding-left: 18px;
      font-size: 14px;
    }

    .notes-list li {
      margin: 2px 0;
    }

    /* -------- Item result styling -------- */
    .item-block {
      margin-bottom: 10px;
    }

    .item-title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .item-price {
      font-size: 20px;
      margin-left: 4px;
    }

    .quest-tag {
      color: #ffd700;
      font-size: 18px;
      margin-left: 10px;
    }

    .line {
      margin: 4px 0;
      font-size: 18px;
    }

    .rarity-letter {
      display: inline-block;
      min-width: 1.1em;
      text-align: center;
    }

    .recycle-tags {
      margin-left: 8px;
      font-size: 15px;
    }

    hr {
      border: 1px solid #333;
      margin: 10px 0;
    }

    /* Small footer for attribution */
    .footer {
      margin-top: 20px;
      font-size: 12px;
      color: #777;
    }

    .footer a {
      color: #999;
    }
  </style>
</head>
<body>

  <div class="top-buttons" id="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit?gid=732163012#gid=732163012"
       target="_blank">Spreadsheet</a>
    <button id="show-notes-btn" type="button">Important Notes</button>
  </div>

  <!-- Legend: only shown while there is an active search -->
  <div id="legend" class="legend hidden">
    <div class="legend-title">How to read the colors</div>

    <div class="legend-row">
      <strong>Item name (rarity):</strong>
      <span class="legend-chip legend-rarity-uncommon">Uncommon</span>
      <span class="legend-chip legend-rarity-rare">Rare</span>
      <span class="legend-chip legend-rarity-epic">Epic</span>
      <span class="legend-chip legend-rarity-legendary">Legendary</span>
    </div>

    <div class="legend-row">
      <strong>Price color (sell value):</strong>
      <span class="legend-chip legend-price-low">0–1000</span>
      <span class="legend-chip legend-price-uncommon">1001–2000</span>
      <span class="legend-chip legend-price-mid">2001–5000</span>
      <span class="legend-chip legend-price-high">5001+</span>
    </div>
  </div>

  <!-- Important Notes panel (from "Important Notes" tab, col A) -->
  <div id="notes-panel" class="notes-panel hidden">
    <div class="notes-header">
      <span class="notes-title">Important Notes</span>
      <button id="close-notes-btn" class="notes-close-btn" type="button" aria-label="Hide notes">×</button>
    </div>
    <div id="notes-body" class="notes-body">
      <!-- Notes filled in by JS -->
    </div>
  </div>

  <div class="search-row">
    <input id="search" placeholder="Type item name..." autofocus>
    <button id="clear-btn" type="button" aria-label="Clear search">×</button>
  </div>

  <div id="result"></div>

  <div class="footer">
    Data and item values from the in-game sheet. Meta data courtesy of
    <a href="https://metaforge.app/arc-raiders" target="_blank" rel="noopener noreferrer">MetaForge ARC Raiders</a>.
  </div>

  <script>
    // -------------
    // CONFIG
    // -------------

    // Main item CSV exported from your Google Sheet (first sheet)
    const ITEMS_SHEET_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?output=csv";

    // "Important Notes" sheet - same published doc, but restricted to gid=732163012
    // Column A only, one note per row.
    const IMPORTANT_NOTES_SHEET_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=732163012&single=true&output=csv";

    // (Reserved for future MetaForge API integration)
    const METAFORGE_API_BASE = "https://metaforge.app/api/arc-raiders";

    // -------------
    // STATE
    // -------------

    const state = {
      // All items from the CSV (or later from MetaForge)
      items: [],
      // Quick lookup by lowercased name for future merges
      itemsByName: new Map(),
      // Important Notes (plain text rows from column A)
      importantNotes: [],
      itemsLoaded: false,
      notesLoaded: false
    };

    // -------------
    // DOM ELEMENTS
    // -------------

    const searchInput   = document.getElementById("search");
    const resultEl      = document.getElementById("result");
    const topButtonsEl  = document.getElementById("top-buttons");
    const legendEl      = document.getElementById("legend");
    const notesPanelEl  = document.getElementById("notes-panel");
    const notesBodyEl   = document.getElementById("notes-body");
    const showNotesBtn  = document.getElementById("show-notes-btn");
    const clearBtn      = document.getElementById("clear-btn");
    const closeNotesBtn = document.getElementById("close-notes-btn");

    let searchTimer = null;

    // -------------
    // INITIAL LOAD
    // -------------

    // Load item data as soon as the script runs.
    loadItemsFromSheet();

    // -------------
    // EVENT HANDLERS
    // -------------

    // When the search box gains focus, clear any previous search and restore the main view.
    searchInput.addEventListener("focus", function () {
      if (this.value !== "") {
        clearSearchAndResetUI();
      }
    });

    // Debounced search when typing
    searchInput.addEventListener("input", function () {
      const query = this.value.trim();

      clearTimeout(searchTimer);

      if (!query) {
        // Empty input: show main buttons, hide legend, and clear results
        resultEl.innerHTML = "";
        legendEl.classList.add("hidden");
        topButtonsEl.classList.remove("hidden");
        return;
      }

      // Hide top buttons while searching
      topButtonsEl.classList.add("hidden");

      searchTimer = setTimeout(() => {
        if (!state.itemsLoaded) {
          resultEl.innerHTML = "<div class='line'>Loading item data...</div>";
          return;
        }
        runSearch(query);
      }, 120);
    });

    // Clear search and reset everything
    clearBtn.addEventListener("click", function () {
      clearSearchAndResetUI();
      searchInput.focus();
    });

    // Show/hide Important Notes panel
    showNotesBtn.addEventListener("click", function () {
      if (notesPanelEl.classList.contains("hidden")) {
        // If we haven't loaded notes yet, fetch them from the sheet first.
        if (!state.notesLoaded) {
          loadImportantNotes();
        } else {
          notesPanelEl.classList.remove("hidden");
        }
      } else {
        notesPanelEl.classList.add("hidden");
      }
    });

    // Close button in the Important Notes panel
    closeNotesBtn.addEventListener("click", function () {
      notesPanelEl.classList.add("hidden");
    });

    // -------------
    // DATA LOADING
    // -------------

    /**
     * Load item data from the main Google Sheet CSV.
     * This keeps the current behavior: the sheet is the source of items.
     * Later, you can replace this with a MetaForge API loader if desired.
     */
    function loadItemsFromSheet() {
      fetch(ITEMS_SHEET_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }
          return response.text();
        })
        .then(text => {
          const rows = text.replace(/\r/g, "").split("\n");
          if (!rows.length) {
            throw new Error("Empty CSV");
          }

          // First row is header
          rows.shift();

          const items = [];

          for (const row of rows) {
            if (!row.trim()) continue;

            const f = csvSplit(row);

            const item = {
              name:      (f[0] || "").trim(),
              rarity:    (f[1] || "").trim(),
              recycle1:  (f[2] || "").trim(),
              recycle2:  (f[3] || "").trim(),
              sellPrice: (f[4] || "").trim(),
              category:  (f[5] || "").trim(),
              keep1:     (f[6] || "").trim(),
              keep2:     (f[7] || "").trim(),
              keep3:     (f[8] || "").trim(),
              notes:     (f[9] || "").trim()
            };

            if (!item.name) continue;

            items.push(item);
          }

          state.items = items;
          state.itemsByName.clear();
          for (const item of items) {
            state.itemsByName.set(item.name.toLowerCase(), item);
          }
          state.itemsLoaded = true;
        })
        .catch(err => {
          console.error("Error loading items CSV:", err);
          resultEl.innerHTML = "<div class='line'>Error loading item list from the spreadsheet.</div>";
        });
    }

    /**
     * Load Important Notes from the "Important Notes" tab.
     * Uses only column A, one note per row.
     */
    function loadImportantNotes() {
      notesBodyEl.innerHTML = "<div class='line'>Loading Important Notes...</div>";
      notesPanelEl.classList.remove("hidden");

      fetch(IMPORTANT_NOTES_SHEET_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }
          return response.text();
        })
        .then(text => {
          const rows = text.replace(/\r/g, "").split("\n");
          const notes = [];

          for (const row of rows) {
            if (!row.trim()) continue;
            const cols = csvSplit(row);
            const note = (cols[0] || "").trim();
            if (note) notes.push(note);
          }

          state.importantNotes = notes;
          state.notesLoaded = true;
          renderImportantNotes();
        })
        .catch(err => {
          console.error("Error loading Important Notes:", err);
          notesBodyEl.innerHTML =
            "<div class='line'>Error loading Important Notes from the spreadsheet.</div>";
        });
    }

    /**
     * Render Important Notes list into the panel.
     */
    function renderImportantNotes() {
      if (!state.importantNotes.length) {
        notesBodyEl.innerHTML = "<div class='line'>No Important Notes found.</div>";
        return;
      }

      const itemsHtml = state.importantNotes
        .map(note => "<li>" + escapeHtml(note) + "</li>")
        .join("");

      notesBodyEl.innerHTML = "<ul class='notes-list'>" + itemsHtml + "</ul>";
    }

    // -------------
    // SEARCH + RENDERING
    // -------------

    /**
     * Clear the search field, results, and restore the main view.
     */
    function clearSearchAndResetUI() {
      searchInput.value = "";
      clearTimeout(searchTimer);
      resultEl.innerHTML = "";
      legendEl.classList.add("hidden");
      topButtonsEl.classList.remove("hidden");
    }

    /**
     * Return an array of quest names from keep1/keep2/keep3.
     */
    function getQuestNames(item) {
      const quests = [];
      if (item.keep1) quests.push(item.keep1.trim());
      if (item.keep2) quests.push(item.keep2.trim());
      if (item.keep3) quests.push(item.keep3.trim());
      return quests;
    }

    /**
     * Main search: match by partial item name (case insensitive).
     */
    function runSearch(query) {
      const q = query.toLowerCase();

      const matches = state.items.filter(
        item => item.name.toLowerCase().includes(q)
      );

      if (!matches.length) {
        resultEl.innerHTML = "<div class='line'>No match</div>";
        legendEl.classList.add("hidden");
        return;
      }

      let html = "";

      for (const item of matches) {
        html += renderItem(item);
      }

      resultEl.innerHTML = html;
      legendEl.classList.remove("hidden");
    }

    /**
     * Render a single item block (title, recycle chains, notes).
     */
    function renderItem(item) {
      const nameColor = rarityColor(item.rarity);

      const priceNumber = getNumericPrice(item.sellPrice);
      const priceColor = priceColorFromValue(priceNumber);

      const questNames = getQuestNames(item);
      const questTag = questNames.length
        ? "<span class='quest-tag'>[" + questNames.map(escapeHtml).join(", ") + "]</span>"
        : "";

      const recyclesToParts = [];
      if (item.recycle1) recyclesToParts.push(item.recycle1);
      if (item.recycle2) recyclesToParts.push(item.recycle2);

      const recyclers = findRecyclersForItem(item.name);

      let html = "";

      // Title line: colored name and price
      html += "<div class='item-block'>";
      html += "<div class='item-title'>" +
                "<span style='color:" + nameColor + ";'>" + escapeHtml(item.name) + "</span>" +
                "<span class='item-price' style='color:" + priceColor + ";'> — " +
                  escapeHtml(item.sellPrice) +
                "</span>" +
                questTag +
              "</div>";

      // "Recycles To" section
      if (recyclesToParts.length) {
        const list = recyclesToParts.map(escapeHtml).join(", ");
        html += "<div class='line'>Recycles To: " + list + "</div>";
      }

      // "Recycled From" section with rarity letter and R-#
      if (recyclers.length) {
        html += "<div class='line' style='color:#ffa500;'>Recycled From:</div>";

        for (const rec of recyclers) {
          const src = rec.source;

          const rarityClr = rarityColor(src.rarity);
          const rarityLetter = getRarityLetter(src.rarity);

          const srcPriceNumber = getNumericPrice(src.sellPrice);
          const srcPriceColor = priceColorFromValue(srcPriceNumber);

          const tags = [];
          if (rec.recycleAmount > 0) {
            tags.push("R-" + rec.recycleAmount);
          }
          if (rec.salvageAmount > 0) {
            tags.push("S-" + rec.salvageAmount);
          }
          const amountTag = tags.length
            ? "<span class='recycle-tags'>" + tags.join("  ") + "</span>"
            : "";

          const srcQuests = getQuestNames(src);
          const srcQuestTag = srcQuests.length
            ? "<span class='quest-tag'>[" + srcQuests.map(escapeHtml).join(", ") + "]</span>"
            : "";

          html += "<div class='line'>" +
                    "<span style='color:#ffffff; font-weight:bold;'>" +
                      escapeHtml(src.name) +
                    "</span>";

          if (rarityLetter) {
            html += "<span class='rarity-letter' " +
                    "style='color:" + rarityClr + "; font-weight:bold; margin-left:6px;'>" +
                      rarityLetter +
                    "</span>";
          }

          if (amountTag) {
            html += " " + amountTag;
          }

          html += " — " +
                    "<span style='color:" + srcPriceColor + "; font-weight:bold;'>" +
                      escapeHtml(src.sellPrice) +
                    "</span>" +
                    srcQuestTag +
                  "</div>";
        }
      }

      // Optional notes from the sheet
      if (item.notes) {
        html += "<div class='line'>Notes: " + escapeHtml(item.notes) + "</div>";
      }

      html += "<hr></div>";

      return html;
    }

    /**
     * Find all items that recycle into the given target item.
     * Uses recycle1/recycle2 text like "3 x Wires".
     * Returns an array: { source, recycleAmount, salvageAmount }
     * (salvageAmount is reserved for future API wiring and is 0 for now).
     */
    function findRecyclersForItem(targetName) {
      const target = targetName.toLowerCase();
      const result = [];

      for (const src of state.items) {
        let recycleAmount = 0;
        let salvageAmount = 0; // Placeholder for future "salvages into" data

        if (src.recycle1) {
          const info1 = parseRecycleString(src.recycle1);
          if (info1.name && info1.name.toLowerCase() === target) {
            recycleAmount += info1.amount;
          }
        }

        if (src.recycle2) {
          const info2 = parseRecycleString(src.recycle2);
          if (info2.name && info2.name.toLowerCase() === target) {
            recycleAmount += info2.amount;
          }
        }

        if (recycleAmount > 0 || salvageAmount > 0) {
          result.push({ source: src, recycleAmount, salvageAmount });
        }
      }

      return result;
    }

    // -------------
    // HELPERS
    // -------------

    /**
     * Split a single CSV row into fields, handling quoted fields with commas.
     */
    function csvSplit(row) {
      const out = [];
      let field = "";
      let inQuotes = false;

      for (const ch of row) {
        if (ch === "\"") {
          inQuotes = !inQuotes;
          continue;
        }
        if (ch === "," && !inQuotes) {
          out.push(field);
          field = "";
          continue;
        }
        field += ch;
      }

      out.push(field);
      return out;
    }

    /**
     * Strip "3 x " from "3 x Wires" and return just "Wires".
     */
    function extractItemNameFromRecycle(str) {
      return str.replace(/^\s*\d+\s*x\s*/i, "").trim();
    }

    /**
     * Extract numeric amount from "3 x Wires" (defaults to 1 if no number).
     */
    function extractAmountFromRecycle(str) {
      const match = str.match(/^\s*(\d+)\s*x\s*/i);
      if (!match) return 1;
      const n = parseInt(match[1], 10);
      return Number.isFinite(n) && n > 0 ? n : 1;
    }

    /**
     * Parse a recycle string into { amount, name }.
     */
    function parseRecycleString(str) {
      const trimmed = (str || "").trim();
      if (!trimmed) return { amount: 0, name: "" };
      return {
        amount: extractAmountFromRecycle(trimmed),
        name: extractItemNameFromRecycle(trimmed)
      };
    }

    /**
     * Convert a sellPrice string into a numeric value.
     * Removes all non-digits, so "1,280" or "1280 Tokens" both work.
     */
    function getNumericPrice(priceStr) {
      if (!priceStr) return 0;
      const digits = priceStr.replace(/[^0-9]/g, "");
      if (!digits) return 0;
      return parseInt(digits, 10);
    }

    /**
     * Map rarity text to a color.
     */
    function rarityColor(rarity) {
      const r = (rarity || "").toLowerCase();
      if (r.includes("uncommon"))  return "#00ff00";
      if (r.includes("rare"))      return "#1e90ff";
      if (r.includes("epic"))      return "#ff00ff";
      if (r.includes("legendary")) return "#ffd700";
      return "white";
    }

    /**
     * Map rarity text to a 1-letter code for the "Recycled From" line.
     */
    function getRarityLetter(rarity) {
      const r = (rarity || "").toLowerCase();
      if (r.includes("uncommon"))  return "U";
      if (r.includes("rare"))      return "R";
      if (r.includes("epic"))      return "E";
      if (r.includes("legendary")) return "L";
      // For "common" or unknown, no letter to keep the UI clean.
      return "";
    }

    /**
     * Map numeric sell price to a color band:
     * 0–1000: white
     * 1001–2000: green
     * 2001–5000: pink
     * 5001+: gold
     */
    function priceColorFromValue(n) {
      if (n >= 1001 && n <= 2000) return "#00ff00"; // "uncommon" price band
      if (n >= 2001 && n <= 5000) return "#ff69b4";
      if (n >= 5001)              return "#ffd700";
      return "#ffffff";
    }

    /**
     * Simple HTML escaping for any user/game text we render with innerHTML.
     */
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (ch) {
        switch (ch) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case "\"": return "&quot;";
          case "'": return "&#39;";
          default: return ch;
        }
      });
    }

    // -------------
    // METAForge API HOOK (for later)
    // -------------

    /**
     * Example of how you could swap the sheet for the MetaForge API:
     *
     * 1. Fetch items from METAFORGE_API_BASE + "/items?perPage=500"
     * 2. Inspect the JSON structure in your browser DevTools.
     * 3. Map each API item to the same shape used above in renderItem().
     *
     * Once you have the field names, you could:
     *   - Replace loadItemsFromSheet() with this function, or
     *   - Call both (API for core data, sheet for extra notes) and merge them.
     *
     * Keeping this here as a clearly documented hook, but not calling it yet
     * so your current sheet-based version continues to work.
     */
    async function loadItemsFromMetaForgeExample() {
      try {
        const response = await fetch(METAFORGE_API_BASE + "/items?perPage=500");
        if (!response.ok) {
          throw new Error("HTTP " + response.status);
        }

        const json = await response.json();

        // Depending on the actual response shape, adjust these lines.
        const apiItems = Array.isArray(json.data) ? json.data : json;

        const items = apiItems.map(apiItem => {
          // TODO: Replace property names below with the real ones
          const name   = apiItem.name || "";
          const rarity = apiItem.rarity || "";
          const value  = apiItem.value != null ? String(apiItem.value) : "";

          // You can also pull recycle/crafting info here once you see
          // which fields MetaForge exposes for components / recycling.
          return {
            name:      name,
            rarity:    rarity,
            recycle1:  "",         // map from API when available
            recycle2:  "",
            sellPrice: value,
            category:  apiItem.type || "",
            keep1:     "",         // you can merge your sheet "keep" flags here
            keep2:     "",
            keep3:     "",
            notes:     ""          // merge per-item notes from your own sheet by name
          };
        });

        state.items = items;
        state.itemsByName.clear();
        for (const item of items) {
          state.itemsByName.set(item.name.toLowerCase(), item);
        }
        state.itemsLoaded = true;
      } catch (err) {
        console.error("Error loading items from MetaForge API:", err);
        resultEl.innerHTML =
          "<div class='line'>Error loading items from MetaForge API. See console for details.</div>";
      }
    }
  </script>
</body>
</html>
