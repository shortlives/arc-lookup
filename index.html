<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>
<style>
  body {
    background:#000;
    color:#fff;
    font-family:Segoe UI, sans-serif;
    padding:20px;
  }
  input, button {
    font-size:22px;
    padding:12px;
    width:95%;
    margin-bottom:15px;
  }
  .item-name {
    font-size:26px;
    font-weight:bold;
  }
  .line {
    margin:4px 0;
    font-size:18px;
  }
  .section-header {
    margin:10px 0 4px 0;
    font-size:20px;
    font-weight:bold;
    color:#ffa500;
  }
  hr {
    border:1px solid #333;
    margin:10px 0;
  }
  .debug-block {
    margin:4px 0;
    font-size:14px;
    color:#aaa;
  }
  details.debug {
    margin-top:6px;
    margin-bottom:4px;
    border:1px solid #333;
    padding:4px 8px;
    border-radius:4px;
    background:#111;
  }
  details.debug summary {
    cursor:pointer;
    font-size:14px;
    color:#0af;
  }
</style>
</head>
<body>

<input id="search" placeholder="Type item name..." autofocus>
<div id="result"></div>

<script>
// ===== MAIN ITEM DATA (existing sheet: your cheat sheet) =====
const sheetURL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?output=csv";

// ===== SHARED NOTES SHEET (second tab in your doc) =====
// Doc ID: 1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U
// gid:    732163012
// Columns: A = Item Name, B = My Notes
const notesURL =
  "https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/export?format=csv&gid=732163012";

// ===== EXTERNAL GAME DATA SOURCES =====

// MetaForge ARC Raiders API (items)
const metaForgeURL = "https://metaforge.app/api/arc-raiders/items";

// RaidTheory arcraiders-data (items JSON; path assumed)
const raidTheoryURL =
  "https://raw.githubusercontent.com/RaidTheory/arcraiders-data/main/items.json";

// ---- Local data structures ----
const data = [];        // main item data from your sheet
const notesMap = {};    // itemName (lowercase) -> note text

let metaForgeData = [];
let raidTheoryData = [];
let metaForgeByName = {};   // lower(name) -> object
let raidTheoryByName = {};  // lower(name) -> object

let metaForgeLoaded = false;
let raidTheoryLoaded = false;

// ---- Load main item data (your cheat sheet) ----
fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const rows = text.replace(/\r/g, "").split("\n");
    rows.shift(); // header row

    for (let r of rows) {
      if (!r.trim()) continue;
      const f = csvSplit(r);
      data.push({
        // A–J: Name, Rarity, RecyclesTo1, RecyclesTo2, Sell Price,
        //      Category, Keep1, Keep2, Keep3, My Notes
        name:      f[0] || "",
        rarity:    f[1] || "",
        recycle1:  f[2] || "",
        recycle2:  f[3] || "",
        sellPrice: f[4] || "",
        category:  f[5] || "",
        keep1:     f[6] || "",
        keep2:     f[7] || "",
        keep3:     f[8] || "",
        notes:     f[9] || ""
      });
    }
  })
  .catch(err => {
    console.error("Error loading main sheet:", err);
  });

// ---- Load shared notes from second tab ----
fetch(notesURL)
  .then(r => r.text())
  .then(text => {
    const rows = text.replace(/\r/g, "").split("\n");
    rows.shift(); // header row: Item Name, My Notes

    for (let r of rows) {
      if (!r.trim()) continue;
      const f = csvSplit(r);
      const itemName = (f[0] || "").trim();
      const noteText = (f[1] || "").trim();
      if (!itemName || !noteText) continue;
      notesMap[itemName.toLowerCase()] = noteText;
    }
  })
  .catch(err => {
    console.error("Error loading notes sheet:", err);
  });

// ---- Load MetaForge items ----
fetch(metaForgeURL)
  .then(r => r.json())
  .then(json => {
    // Some APIs wrap data, some return array directly; handle both
    metaForgeData = Array.isArray(json) ? json : (json.data || json.items || []);
    metaForgeByName = indexByName(metaForgeData, ["name", "itemName", "label"]);
    metaForgeLoaded = true;
    console.log("MetaForge items loaded:", metaForgeData.length);
  })
  .catch(err => {
    console.error("Error loading MetaForge API:", err);
  });

// ---- Load RaidTheory items ----
fetch(raidTheoryURL)
  .then(r => r.json())
  .then(json => {
    // In this repo it's usually an array of item objects
    raidTheoryData = Array.isArray(json) ? json : (json.items || []);
    raidTheoryByName = indexByName(raidTheoryData, ["name", "itemName", "label"]);
    raidTheoryLoaded = true;
    console.log("RaidTheory items loaded:", raidTheoryData.length);
  })
  .catch(err => {
    console.error("Error loading RaidTheory data:", err);
  });

// ---- CSV splitter ----
function csvSplit(row) {
  let out = [], field = "", q = false;
  for (const ch of row) {
    if (ch === '"') { q = !q; continue; }
    if (ch === ',' && !q) { out.push(field); field = ""; continue; }
    field += ch;
  }
  out.push(field);
  return out;
}

// ---- Index arbitrary array of objects by name-like key ----
function indexByName(arr, possibleNameKeys) {
  const map = {};
  arr.forEach(obj => {
    if (!obj || typeof obj !== "object") return;
    let nm = null;
    for (const key of possibleNameKeys) {
      if (typeof obj[key] === "string" && obj[key].trim()) {
        nm = obj[key].trim();
        break;
      }
    }
    if (!nm) return;
    map[nm.toLowerCase()] = obj;
  });
  return map;
}

// Strip "2x " patterns to match names (e.g. "2x ARC Motion Core" -> "ARC Motion Core")
function extractItemNameFromRecycle(str) {
  return str.replace(/^\s*\d+\s*x\s*/i, "").trim();
}

/* ===== FAST SEARCH ===== */
let timer = null;
document.getElementById("search").addEventListener("input", function () {
  clearTimeout(timer);
  const q = this.value.trim();
  timer = setTimeout(() => runSearch(q), 100);
});

function runSearch(query) {
  const q = query.toLowerCase();
  const out = document.getElementById("result");
  out.innerHTML = "";
  if (!q) return;

  const matches = data.filter(d => d.name.toLowerCase().includes(q));
  if (!matches.length) {
    out.innerHTML = "<div>No match</div>";
    return;
  }

  let html = "";

  // ========== MAIN ITEM CARDS ==========
  matches.forEach(item => {
    const rarity = (item.rarity || "").toLowerCase();
    let nameColor = "white";

    if (rarity.includes("uncommon")) nameColor = "#00ff00";
    else if (rarity.includes("rare")) nameColor = "#1e90ff";
    else if (rarity.includes("epic")) nameColor = "#ff00ff";
    else if (rarity.includes("legendary")) nameColor = "#ffd700";

    const priceNum = parseInt((item.sellPrice || "").replace(/[^0-9]/g,"")) || 0;
    let priceColor = "white";

    if (priceNum >= 1000 && priceNum <= 2000) priceColor = "#00ff00";
    else if (priceNum >= 2001 && priceNum <= 5000) priceColor = "#ff69b4";
    else if (priceNum >= 5001) priceColor = "#ffd700";

    const recycleParts = [];
    if (item.recycle1) recycleParts.push(item.recycle1);
    if (item.recycle2) recycleParts.push(item.recycle2);

    // Combine Quest fields into one line
    const questParts = [];
    if (item.keep1) questParts.push(item.keep1);
    if (item.keep2) questParts.push(item.keep2);
    if (item.keep3) questParts.push(item.keep3);

    // Notes preference: shared notes tab overrides main-sheet notes
    const noteFromMap = notesMap[item.name.toLowerCase()];
    const noteText = noteFromMap || item.notes;

    // Lookups in external sources for debug mode
    const key = item.name.toLowerCase();
    const mfItem = metaForgeByName[key];
    const rtItem = raidTheoryByName[key];

    html += `
      <div class="item-name" style="color:${nameColor}">${item.name}</div>
      ${item.rarity ? `<div class="line">Rarity: ${item.rarity}</div>` : ""}
      ${item.category ? `<div class="line">Category: ${item.category}</div>` : ""}
      ${item.sellPrice ? `<div class="line" style="color:${priceColor}; font-weight:bold;">Sell Price: ${item.sellPrice}</div>` : ""}
      ${recycleParts.length ? `<div class="line">Recycles To: ${recycleParts.join(", ")}</div>` : ""}
      ${questParts.length ? `<div class="line">Quest: ${questParts.join(", ")}</div>` : ""}
      ${noteText ? `<div class="line">Notes: ${noteText}</div>` : ""}
      ${buildDebugBlock(mfItem, rtItem)}
      <hr>
    `;
  });

  // ========== REVERSE RECYCLE LOOKUP ==========
  const exact = data.find(d => d.name.toLowerCase() === q);
  const targetName = exact ? exact.name : matches[0].name;
  const targetNameLower = targetName.toLowerCase();

  const recyclers = data.filter(d => {
    if (!d.recycle1 && !d.recycle2) return false;

    const r1 = extractItemNameFromRecycle(d.recycle1 || "").toLowerCase();
    const r2 = extractItemNameFromRecycle(d.recycle2 || "").toLowerCase();

    const givesTarget = (r1 === targetNameLower || r2 === targetNameLower);
    const isSameItem = d.name.toLowerCase() === targetNameLower;

    return givesTarget && !isSameItem;
  });

  if (recyclers.length) {
    html += `<div class="section-header">Items that recycle into ${targetName}:</div>`;
    recyclers.forEach(src => {
      html += `
        <div class="line">• ${src.name}</div>
      `;
    });
  }

  // Attribution / debug footer
  html += `
    <hr>
    <div class="line" style="font-size:12px;color:#777;">
      Data sources: Main sheet (your cheat data) + MetaForge API + RaidTheory arcraiders-data.
      Debug shows which external sources matched each item.
    </div>
  `;

  out.innerHTML = html;
}

// Build debug detail block for each item
function buildDebugBlock(mfItem, rtItem) {
  const mfStatus = metaForgeLoaded
    ? (mfItem ? "found" : "not found")
    : "loading…";
  const rtStatus = raidTheoryLoaded
    ? (rtItem ? "found" : "not found")
    : "loading…";

  // Limit key listing so it doesn't explode
  const mfKeys = mfItem ? Object.keys(mfItem).slice(0, 20) : [];
  const rtKeys = rtItem ? Object.keys(rtItem).slice(0, 20) : [];

  return `
    <details class="debug">
      <summary>Debug: Data sources (MetaForge: ${mfStatus}, RaidTheory: ${rtStatus})</summary>
      <div class="debug-block">
        MetaForge: ${mfStatus}${
          mfKeys.length ? `<br>Keys: ${mfKeys.join(", ")}` : ""
        }
      </div>
      <div class="debug-block">
        RaidTheory: ${rtStatus}${
          rtKeys.length ? `<br>Keys: ${rtKeys.join(", ")}` : ""
        }
      </div>
    </details>
  `;
}
</script>
</body>
</html>
