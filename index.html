<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips script (for item/quest hover tooltips) -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Segoe UI, sans-serif;
      padding:20px;
      max-width:900px;
      margin:0 auto;
    }

    .top-buttons {
      display:flex;
      gap:10px;
      margin-bottom:15px;
      flex-wrap:wrap;
    }
    .top-buttons a,
    .top-buttons button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 12px;
      font-size:14px;
      text-decoration:none;
      cursor:pointer;
    }
    .top-buttons a:hover,
    .top-buttons button:hover {
      background:#333;
    }

    .search-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }

    #search {
      font-size:22px;
      padding:12px;
      flex:1;
    }

    #clear-search {
      font-size:18px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#222;
      color:#fff;
      cursor:pointer;
    }
    #clear-search:hover {
      background:#333;
    }

    .instructions {
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      padding:10px 12px;
      font-size:13px;
      margin-bottom:12px;
    }
    .instructions-title {
      font-weight:bold;
      margin-bottom:4px;
    }
    .instructions-row {
      margin:3px 0;
    }
    .pill {
      display:inline-block;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid #444;
      margin-left:4px;
      font-size:12px;
    }

    /* Rarity color pills (match item title colors) */
    .pill-common   { color:#ffffff; }
    .pill-uncommon { color:#00ff00; }
    .pill-rare     { color:#00bfff; }
    .pill-epic     { color:#ff00ff; }
    .pill-legendary{ color:#ffd700; }

    /* Value color pills (match price color logic) */
    .pill-price-1  { color:#ffffff; } /* ≤ 1000 */
    .pill-price-2  { color:#00ff00; } /* 1001–2000 */
    .pill-price-3  { color:#ff69b4; } /* 2001–5000 */
    .pill-price-4  { color:#ffd700; } /* 5001+ */

    .hidden {
      display:none !important;
    }

    .item-block {
      margin:10px 0 14px 0;
    }

    .item-title {
      font-size:26px;
      font-weight:bold;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }

    .item-link {
      text-decoration:none;
    }

    .item-value {
      font-size:20px;
      margin-left:6px;
    }

    .quest-tag {
      font-size:16px;
      margin-left:8px;
      color:#ffd700;
    }

    .line {
      margin:4px 0;
      font-size:18px;
    }

    .line-small {
      margin:3px 0;
      font-size:14px;
      color:#ccc;
    }

    /* Colored hyphen prefix on "Recycled From" lines */
    .rarity-prefix {
      display:inline-block;
      width:18px;
      text-align:center;
      margin-right:4px;
      font-weight:bold;
    }

    .notes-panel {
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      padding:10px 12px;
      margin-bottom:12px;
      font-size:14px;
    }

    .notes-panel h2 {
      margin-top:0;
      font-size:18px;
    }

    .note-item {
      margin:4px 0;
    }

    hr {
      border:1px solid #333;
      margin:10px 0;
    }

    .error {
      color:#ff6666;
    }

    footer {
      margin-top:16px;
      font-size:12px;
      color:#888;
    }
    footer a {
      color:#66b3ff;
    }

    .full-item-btn {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:3px 8px;
      font-size:12px;
      cursor:pointer;
    }
    .full-item-btn:hover {
      background:#333;
    }
  </style>
</head>
<body>
  <div class="top-buttons" id="topButtons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank" rel="noopener noreferrer">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit#gid=491619272"
       target="_blank" rel="noopener noreferrer">Spreadsheet</a>
    <button type="button" id="notesToggle">Important Notes</button>
  </div>

  <div class="search-row">
    <input id="search" placeholder="Type item name..." autofocus>
    <button id="clear-search" type="button" aria-label="Clear search">×</button>
  </div>

  <!-- Shown only when there is text in the search box -->
  <div id="instructions" class="instructions hidden">
    <div class="instructions-title">How to read the colors</div>
    <div class="instructions-row">
      Item Rarity:
      <span class="pill pill-common">Common</span>
      <span class="pill pill-uncommon">Uncommon</span>
      <span class="pill pill-rare">Rare</span>
      <span class="pill pill-epic">Epic</span>
      <span class="pill pill-legendary">Legendary</span>
    </div>
    <div class="instructions-row">
      Sell value:
      <span class="pill pill-price-1">≤ 1000</span>
      <span class="pill pill-price-2">1001–2000</span>
      <span class="pill pill-price-3">2001–5000</span>
      <span class="pill pill-price-4">5001+</span>
    </div>
  </div>

  <!-- Important Notes (Google Sheet "Important Notes" tab) -->
  <div id="notesPanel" class="notes-panel hidden">
    <h2>Important Notes</h2>
    <div id="notesContent">Loading…</div>
  </div>

  <div id="result"></div>

  <footer>
    Data sourced via your Google Sheet and
    <a href="https://metaforge.app/arc-raiders" target="_blank" rel="noopener noreferrer">MetaForge ARC Raiders</a>.
  </footer>

<script>
"use strict";

/**
 * CONFIGURATION
 *
 * MASTER_CSV_URL: published CSV for Items_Master tab.
 * NOTES_CSV_URL: published CSV for "Important Notes" tab.
 */
const MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=491619272&single=true&output=csv";

const NOTES_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=732163012&single=true&output=csv";

/**
 * FULL ITEM LOOKUP CONFIG
 * Toggle any of these to false if you want to hide that line in
 * the Full Item Lookup view.
 */
const FULL_LOOKUP_CONFIG = {
  showApiId:       true,
  showRarity:      true,
  showValue:       true,
  showType:        true,
  showWorkbench:   true,
  showLootArea:    true,
  showSubcategory: true,
  showLoadout:     true,
  showAmmoType:    true,
  showDescription: true,
  showIcon:        true,
  showRecycles:    true,
  showSalvage:     true,
  showNotes:       true,
  showQuests:      true
};

/**
 * GLOBAL STATE
 */
const state = {
  items: [],            // enabled items from Items_Master
  itemByName: new Map(),// normalized name -> item (includes disabled for Full Info)
  importantNotes: [],
  dataLoaded: false,
  notesLoaded: false,
  notesError: null
};

// DOM cache
const dom = {
  search:        document.getElementById("search"),
  clearSearch:   document.getElementById("clear-search"),
  topButtons:    document.getElementById("topButtons"),
  instructions:  document.getElementById("instructions"),
  result:        document.getElementById("result"),
  notesPanel:    document.getElementById("notesPanel"),
  notesContent:  document.getElementById("notesContent"),
  notesToggle:   document.getElementById("notesToggle")
};

/**
 * UTILITIES
 */

function normalizeName(str) {
  return (str || "").trim().toLowerCase();
}

function slugifyName(str) {
  return (str || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, ch => {
    switch (ch) {
      case "&": return "&amp;";
      case "<": return "&lt;";
      case ">": return "&gt;";
      case '"': return "&quot;";
      case "'": return "&#39;";
      default:  return ch;
    }
  });
}

function csvSplit(row) {
  const out = [];
  let field = "";
  let inQuotes = false;

  for (const ch of row) {
    if (ch === '"') {
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) {
      out.push(field);
      field = "";
      continue;
    }
    field += ch;
  }
  out.push(field);
  return out;
}

function rarityColor(rarity) {
  const r = (rarity || "").toLowerCase();
  if (r.includes("uncommon"))  return "#00ff00";
  if (r.includes("rare"))      return "#00bfff";
  if (r.includes("epic"))      return "#ff00ff";
  if (r.includes("legendary")) return "#ffd700";
  return "#ffffff";
}

function priceColor(value) {
  const n = Number(value) || 0;
  if (n <= 1000)  return "#ffffff";
  if (n <= 2000)  return "#00ff00";
  if (n <= 5000)  return "#ff69b4";
  return "#ffd700";
}

function parseRecycleEntry(entry) {
  if (!entry) return null;
  const trimmed = entry.trim();
  if (!trimmed) return null;

  const m = trimmed.match(/^\s*(\d+)\s*x?\s*(.+)$/i);
  if (!m) {
    return { qty: null, itemName: trimmed };
  }
  return {
    qty: parseInt(m[1], 10),
    itemName: m[2].trim()
  };
}

/**
 * DATA LOADING
 */

async function init() {
  dom.result.textContent = "Loading item data…";
  attachEventHandlers();

  try {
    const masterCsv = await fetchTextSafe(MASTER_CSV_URL);
    if (!masterCsv) {
      throw new Error("Failed to load Items_Master CSV.");
    }

    parseItemsMasterCsv(masterCsv);

    console.log("Parsed items from Items_Master (enabled):", state.items.length);

    if (!state.items.length) {
      dom.result.innerHTML =
        '<div class="error">No enabled items parsed from Items_Master. ' +
        'Check that the published CSV is the Items_Master tab and that the "name" column is filled.</div>';
      return;
    }

    state.dataLoaded = true;
    dom.result.textContent = "Type an item name above to search.";
  } catch (err) {
    console.error(err);
    dom.result.innerHTML =
      '<div class="error">Error loading data from Items_Master CSV. Check the published URL.</div>';
  }
}

async function fetchTextSafe(url) {
  if (!url) return null;
  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    return res.text();
  } catch {
    return null;
  }
}

/**
 * Parse Items_Master CSV into state.items.
 *
 * Expected headers (case-insensitive):
 * api_id, name, rarity, value, item_type, workbench, loot_area, subcategory,
 * loadout_slots, recycle1, recycle2, salvage1, salvage2, notes, enabled,
 * quest1, quest2, quest3, description, ammo_type, icon, loadout_slots
 */
function parseItemsMasterCsv(csvText) {
  const rows = csvText.replace(/\r/g, "").split("\n");
  if (!rows.length) return;

  const headerFields = csvSplit(rows[0]).map(h => h.trim());
  const colIndex = {};
  headerFields.forEach((h, i) => {
    if (!h) return;
    colIndex[h.toLowerCase()] = i; // last duplicate wins (e.g. second loadout_slots)
  });

  function getField(fields, colName) {
    const idx = colIndex[colName];
    return idx == null ? "" : (fields[idx] || "");
  }

  const items = [];
  state.itemByName.clear();

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row.trim()) continue;

    const fields = csvSplit(row);

    const name = getField(fields, "name").trim();
    if (!name) continue;

    const apiId        = getField(fields, "api_id").trim() || null;
    const rarity       = getField(fields, "rarity").trim();
    const valueStr     = getField(fields, "value").trim();
    const itemType     = getField(fields, "item_type").trim();
    const workbench    = getField(fields, "workbench").trim();
    const lootArea     = getField(fields, "loot_area").trim();
    const subcategory  = getField(fields, "subcategory").trim();
    const loadoutSlots = getField(fields, "loadout_slots").trim(); // last loadout_slots column
    const recycle1     = getField(fields, "recycle1").trim();
    const recycle2     = getField(fields, "recycle2").trim();
    const salvage1     = getField(fields, "salvage1").trim();
    const salvage2     = getField(fields, "salvage2").trim();
    const notes        = getField(fields, "notes").trim();
    const enabledRaw   = getField(fields, "enabled").trim();
    const quest1       = getField(fields, "quest1").trim();
    const quest2       = getField(fields, "quest2").trim();
    const quest3       = getField(fields, "quest3").trim();
    const description  = getField(fields, "description").trim();
    const ammoType     = getField(fields, "ammo_type").trim();
    const icon         = getField(fields, "icon").trim();

    const value = valueStr ? Number(valueStr) || 0 : 0;

    // Default enabled = TRUE if blank; treat explicit FALSE/0/no as disabled
    const enabled =
      enabledRaw === "" ||
      !["false", "0", "no"].includes(enabledRaw.toLowerCase());

    const manualQuestNames = [quest1, quest2, quest3].filter(q => q);

    const item = {
      apiId,
      name,
      rarity,
      value,
      itemType,
      workbench,
      lootArea,
      subcategory,
      loadoutSlots,
      recycle1,
      recycle2,
      salvage1,
      salvage2,
      notes,
      enabled,
      manualQuestNames,
      description,
      ammoType,
      icon
    };

    // All items available for Full Info lookup
    state.itemByName.set(normalizeName(name), item);

    // Only enabled items participate in search results
    if (enabled) {
      items.push(item);
    }
  }

  state.items = items;
}

/**
 * IMPORTANT NOTES LOADING
 */

async function ensureNotesLoaded() {
  if (state.notesLoaded || state.notesError || !NOTES_CSV_URL) return;

  try {
    const text = await fetchTextSafe(NOTES_CSV_URL);
    if (!text) {
      state.notesError = "Error loading Important Notes from the spreadsheet.";
      return;
    }

    const rows = text.replace(/\r/g, "").split("\n");
    state.importantNotes = [];

    for (const row of rows) {
      if (!row.trim()) continue;
      const fields = csvSplit(row);
      const note = (fields[0] || "").trim();
      if (note) {
        state.importantNotes.push(note);
      }
    }

    state.notesLoaded = true;
  } catch (err) {
    console.error(err);
    state.notesError = "Error loading Important Notes from the spreadsheet.";
  }
}

function renderNotesPanel() {
  if (!NOTES_CSV_URL) {
    dom.notesContent.innerHTML =
      '<div class="error">NOTES_CSV_URL is not set yet. Publish your "Important Notes" tab and paste its CSV link into the script.</div>';
    return;
  }

  if (state.notesError) {
    dom.notesContent.innerHTML = '<div class="error">' + escapeHtml(state.notesError) + '</div>';
    return;
  }

  if (!state.importantNotes.length) {
    dom.notesContent.textContent = "No notes found.";
    return;
  }

  const itemsHtml = state.importantNotes
    .map(n => '<div class="note-item">• ' + escapeHtml(n) + '</div>')
    .join("");
  dom.notesContent.innerHTML = itemsHtml;
}

/**
 * SEARCH + RENDER (normal ARC lookup)
 */

let searchDebounceTimer = null;

function runSearch(queryRaw) {
  const query = queryRaw.trim();
  const qNorm = normalizeName(query);

  dom.result.innerHTML = "";

  if (!state.dataLoaded) {
    dom.result.textContent = "Still loading data…";
    return;
  }

  if (!qNorm) {
    dom.result.textContent = "Type an item name above to search.";
    return;
  }

  const matches = state.items.filter(it =>
    normalizeName(it.name).includes(qNorm)
  );

  if (!matches.length) {
    dom.result.innerHTML = "<div>No match</div>";
    return;
  }

  matches.sort((a, b) => {
    const aName = normalizeName(a.name);
    const bName = normalizeName(b.name);
    const aStarts = aName.startsWith(qNorm) ? 0 : 1;
    const bStarts = bName.startsWith(qNorm) ? 0 : 1;
    if (aStarts !== bStarts) return aStarts - bStarts;
    return aName.localeCompare(bName);
  });

  let html = "";
  for (const item of matches) {
    html += renderItemBlock(item);
  }
  dom.result.innerHTML = html;
}

function renderItemBlock(item) {
  const rarityClr = rarityColor(item.rarity);
  const valueNum = Number(item.value) || 0;
  const valueText = valueNum ? valueNum.toLocaleString("en-US") : "";
  const valueClr = priceColor(valueNum);

  const itemUrl = item.apiId
    ? "https://metaforge.app/arc-raiders/database/item/" + encodeURIComponent(item.apiId)
    : null;

  const recycledFrom = findRecyclersForItem(item.name);
  const manualQuestTagHtml = renderManualQuestTags(item.manualQuestNames);

  let html = '<div class="item-block">';

  // Title line (with optional "Full Info" button)
  html += '<div class="item-title">';
  let titleInner = "";

  if (itemUrl) {
    titleInner += '<a class="item-link" href="' + itemUrl +
                  '" target="_blank" rel="noopener noreferrer">' +
                  '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>" +
                  "</a>";
  } else {
    titleInner += '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>";
  }

  if (valueText) {
    titleInner += '<span class="item-value" style="color:' + valueClr + ';"> — ' +
                  escapeHtml(valueText) + "</span>";
  }

  if (manualQuestTagHtml) {
    titleInner += " " + manualQuestTagHtml;
  }

  html += titleInner;

  // Full Info button for this main item
  html += '<button type="button" class="full-item-btn" data-item-name="' +
          escapeHtml(item.name) + '">Full Info</button>';

  html += "</div>";

  // Recycles To (sheet overlay)
  const recToParts = [];
  if (item.recycle1) recToParts.push(item.recycle1);
  if (item.recycle2) recToParts.push(item.recycle2);

  if (recToParts.length) {
    html += '<div class="line">Recycles To: ' +
            recToParts.map(escapeHtml).join(", ") + "</div>";
  }

  // Recycled From: colored hyphen + item name + R/S tags + price
  if (recycledFrom.length) {
    html += '<div class="line" style="color:#ffa500;">Recycled From: ' +
            '<span class="line-small">R = Recycled, S = Salvaged</span>' +
            "</div>";

    for (const src of recycledFrom) {
      const rarityClrSrc = rarityColor(src.rarity);
      const srcValueNum = Number(src.value) || 0;
      const srcValueText = srcValueNum ? srcValueNum.toLocaleString("en-US") : "";
      const srcValueColor = priceColor(srcValueNum);

      const srcManualQuestTag = renderManualQuestTags(src.manualQuestNames);

      const rsParts = [];
      if (src.qty !== null) rsParts.push("R-" + src.qty);
      if (src.salvageQty != null) rsParts.push("S-" + src.salvageQty);

      html += '<div class="line">';
      // colored hyphen prefix (rarity color)
      html += '<span class="rarity-prefix" style="color:' + rarityClrSrc + ';">-</span>';
      // item name (white)
      html += '<span style="color:#ffffff; font-weight:bold;">' +
              escapeHtml(src.name) + "</span>";
      // R/S tags (between name and value)
      if (rsParts.length) {
        html += ' <span class="line-small">' + rsParts.join(" · ") + "</span>";
      }
      // value
      if (srcValueText) {
        html += ' — <span style="color:' + srcValueColor +
                '; font-weight:bold;">' + escapeHtml(srcValueText) + "</span>";
      }
      // quest tag, if any
      if (srcManualQuestTag) {
        html += " " + srcManualQuestTag;
      }
      html += "</div>";
    }
  }

  if (item.notes) {
    html += '<div class="line">Notes: ' + escapeHtml(item.notes) + "</div>";
  }

  html += "<hr></div>";
  return html;
}

function renderManualQuestTags(questNames) {
  if (!questNames || !questNames.length) return "";
  const parts = questNames.map(q => escapeHtml(q));
  return '<span class="quest-tag">[Needed for: ' + parts.join(", ") + "]</span>";
}

/**
 * Find all items that recycle into the target item (Recycled From list),
 * using recycle1 / recycle2 from Items_Master.
 */
function findRecyclersForItem(targetName) {
  const targetKey = normalizeName(targetName);
  const results = [];

  for (const item of state.items) {
    const entries = [item.recycle1, item.recycle2];
    let totalQty = 0;
    let hasMatch = false;

    for (const entry of entries) {
      const parsed = parseRecycleEntry(entry);
      if (!parsed) continue;
      const entryKey = normalizeName(parsed.itemName);
      if (!entryKey || entryKey !== targetKey) continue;

      hasMatch = true;
      if (parsed.qty) totalQty += parsed.qty;
    }

    if (hasMatch) {
      results.push({
        name: item.name,
        rarity: item.rarity,
        value: item.value,
        manualQuestNames: item.manualQuestNames,
        qty: totalQty || null,
        salvageQty: null // reserved for future salvage data
      });
    }
  }

  return results;
}

/**
 * FULL ITEM LOOKUP – by item name (per-item button)
 * Uses the Items_Master row only.
 */
function fullItemLookupByName(name) {
  if (!state.dataLoaded) {
    dom.result.textContent = "Still loading data…";
    return;
  }

  const key = normalizeName(name);
  const item = state.itemByName.get(key);

  if (!item) {
    dom.result.innerHTML =
      '<div class="error">No item found in Items_Master for "' + escapeHtml(name) + '".</div>';
    return;
  }

  dom.result.innerHTML = renderFullItemDetailsFromMaster(item);
  setInstructionsVisible(false);
}

/**
 * Render a full-detail view from Items_Master columns only.
 */
function renderFullItemDetailsFromMaster(item) {
  const rarityClr = rarityColor(item.rarity);
  const valueNum = Number(item.value) || 0;
  const valueText = valueNum ? valueNum.toLocaleString("en-US") : "";
  const valueClr = priceColor(valueNum);
  const itemUrl = item.apiId
    ? "https://metaforge.app/arc-raiders/database/item/" + encodeURIComponent(item.apiId)
    : null;

  let html = '<div class="item-block">';

  // Title
  html += '<div class="item-title">';
  if (itemUrl) {
    html += '<a class="item-link" href="' + itemUrl +
            '" target="_blank" rel="noopener noreferrer">' +
            '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>" +
            "</a>";
  } else {
    html += '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>";
  }
  if (valueText && FULL_LOOKUP_CONFIG.showValue) {
    html += '<span class="item-value" style="color:' + valueClr + ';"> — ' +
            escapeHtml(valueText) + "</span>";
  }
  html += "</div>";

  // Core meta
  if (FULL_LOOKUP_CONFIG.showApiId && item.apiId) {
    html += '<div class="line-small">API ID: ' + escapeHtml(String(item.apiId)) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showRarity && item.rarity) {
    html += '<div class="line-small">Rarity: ' + escapeHtml(item.rarity) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showType && item.itemType) {
    html += '<div class="line-small">Type: ' + escapeHtml(item.itemType) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showWorkbench && item.workbench) {
    html += '<div class="line-small">Workbench: ' + escapeHtml(item.workbench) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showLootArea && item.lootArea) {
    html += '<div class="line-small">Loot Area: ' + escapeHtml(item.lootArea) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showSubcategory && item.subcategory) {
    html += '<div class="line-small">Subcategory: ' + escapeHtml(item.subcategory) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showLoadout && item.loadoutSlots) {
    html += '<div class="line-small">Loadout Slots: ' + escapeHtml(item.loadoutSlots) + "</div>";
  }
  if (FULL_LOOKUP_CONFIG.showAmmoType && item.ammoType) {
    html += '<div class="line-small">Ammo Type: ' + escapeHtml(item.ammoType) + "</div>";
  }

  if (FULL_LOOKUP_CONFIG.showDescription && item.description) {
    html += '<div class="line-small"><strong>Description:</strong> ' +
            escapeHtml(item.description) + "</div>";
  }

  if (FULL_LOOKUP_CONFIG.showIcon && item.icon) {
    html += '<div class="line-small"><strong>Icon:</strong> ' +
            '<a href="' + escapeHtml(item.icon) +
            '" target="_blank" rel="noopener noreferrer">Open icon</a></div>';
  }

  if (FULL_LOOKUP_CONFIG.showRecycles &&
      (item.recycle1 || item.recycle2)) {
    const recParts = [];
    if (item.recycle1) recParts.push(item.recycle1);
    if (item.recycle2) recParts.push(item.recycle2);
    html += '<div class="line-small"><strong>Recycles To:</strong> ' +
            recParts.map(escapeHtml).join(", ") + "</div>";
  }

  if (FULL_LOOKUP_CONFIG.showSalvage &&
      (item.salvage1 || item.salvage2)) {
    const salvParts = [];
    if (item.salvage1) salvParts.push(item.salvage1);
    if (item.salvage2) salvParts.push(item.salvage2);
    html += '<div class="line-small"><strong>Salvages To:</strong> ' +
            salvParts.map(escapeHtml).join(", ") + "</div>";
  }

  if (FULL_LOOKUP_CONFIG.showNotes && item.notes) {
    html += '<div class="line-small"><strong>Notes:</strong> ' +
            escapeHtml(item.notes) + "</div>";
  }

  if (FULL_LOOKUP_CONFIG.showQuests && item.manualQuestNames.length) {
    html += '<div class="line-small"><strong>Needed for:</strong> ' +
            escapeHtml(item.manualQuestNames.join(", ")) + "</div>";
  }

  html += "</div>";
  return html;
}

/**
 * UI HANDLERS
 */

function attachEventHandlers() {
  dom.search.addEventListener("input", () => {
    const value = dom.search.value;

    if (!value.trim()) {
      dom.result.textContent = "Type an item name above to search.";
      setTopButtonsVisible(true);
      setInstructionsVisible(false);
      return;
    }

    setTopButtonsVisible(false);
    setInstructionsVisible(true);

    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      runSearch(value);
    }, 120);
  });

  dom.search.addEventListener("focus", () => {
    if (dom.search.value) {
      dom.search.value = "";
    }
    dom.result.textContent = "Type an item name above to search.";
    setTopButtonsVisible(true);
    setInstructionsVisible(false);
  });

  dom.clearSearch.addEventListener("click", () => {
    dom.search.value = "";
    dom.search.focus();
    dom.result.textContent = "Type an item name above to search.";
    setTopButtonsVisible(true);
    setInstructionsVisible(false);
  });

  dom.notesToggle.addEventListener("click", async () => {
    const isHidden = dom.notesPanel.classList.contains("hidden");
    if (isHidden) {
      await ensureNotesLoaded();
      renderNotesPanel();
      dom.notesPanel.classList.remove("hidden");
    } else {
      dom.notesPanel.classList.add("hidden");
    }
  });

  // Event delegation for per-item "Full Info" buttons inside #result
  dom.result.addEventListener("click", (event) => {
    const btn = event.target.closest(".full-item-btn");
    if (!btn) return;
    const itemName = btn.getAttribute("data-item-name") || "";
    fullItemLookupByName(itemName);
  });
}

function setTopButtonsVisible(visible) {
  if (visible) dom.topButtons.classList.remove("hidden");
  else dom.topButtons.classList.add("hidden");
}

function setInstructionsVisible(visible) {
  if (visible) dom.instructions.classList.remove("hidden");
  else dom.instructions.classList.add("hidden");
}

/**
 * BOOTSTRAP
 */
init();
</script>
</body>
</html>
