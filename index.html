<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips script (for item/quest hover tooltips) -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Segoe UI, sans-serif;
      padding:20px;
      max-width:900px;
      margin:0 auto;
    }

    .top-buttons {
      display:flex;
      gap:10px;
      margin-bottom:15px;
      flex-wrap:wrap;
    }
    .top-buttons a,
    .top-buttons button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 12px;
      font-size:14px;
      text-decoration:none;
      cursor:pointer;
    }
    .top-buttons a:hover,
    .top-buttons button:hover {
      background:#333;
    }

    .search-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }

    #search {
      font-size:22px;
      padding:12px;
      flex:1;
    }

    #clear-search {
      font-size:18px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#222;
      color:#fff;
      cursor:pointer;
    }
    #clear-search:hover {
      background:#333;
    }

    .instructions {
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      padding:10px 12px;
      font-size:13px;
      margin-bottom:12px;
    }
    .instructions-title {
      font-weight:bold;
      margin-bottom:4px;
    }
    .instructions-row {
      margin:3px 0;
    }
    .pill {
      display:inline-block;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid #444;
      margin-left:4px;
      font-size:12px;
    }

    /* Rarity color pills (match item title colors) */
    .pill-common   { color:#ffffff; }
    .pill-uncommon { color:#00ff00; }
    .pill-rare     { color:#00bfff; }
    .pill-epic     { color:#ff00ff; }
    .pill-legendary{ color:#ffd700; }

    /* Value color pills (match price color logic) */
    .pill-price-1  { color:#ffffff; } /* ≤ 1000 */
    .pill-price-2  { color:#00ff00; } /* 1001–2000 */
    .pill-price-3  { color:#ff69b4; } /* 2001–5000 */
    .pill-price-4  { color:#ffd700; } /* 5001+ */

    .hidden {
      display:none !important;
    }

    .item-block {
      margin:10px 0 14px 0;
    }

    .item-title {
      font-size:26px;
      font-weight:bold;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }

    .item-link {
      text-decoration:none;
    }

    .item-value {
      font-size:20px;
      margin-left:6px;
    }

    .quest-tag {
      font-size:16px;
      margin-left:8px;
      color:#ffd700;
    }

    .line {
      margin:4px 0;
      font-size:18px;
    }

    .line-small {
      margin:3px 0;
      font-size:14px;
      color:#ccc;
    }

    /* Colored hyphen prefix on "Recycled From" lines */
    .rarity-prefix {
      display:inline-block;
      width:18px;
      text-align:center;
      margin-right:4px;
      font-weight:bold;
    }

    .notes-panel {
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      padding:10px 12px;
      margin-bottom:12px;
      font-size:14px;
    }

    .notes-panel h2 {
      margin-top:0;
      font-size:18px;
    }

    .note-item {
      margin:4px 0;
    }

    hr {
      border:1px solid #333;
      margin:10px 0;
    }

    .error {
      color:#ff6666;
    }

    footer {
      margin-top:16px;
      font-size:12px;
      color:#888;
    }
    footer a {
      color:#66b3ff;
    }

    .full-item-btn {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:3px 8px;
      font-size:12px;
      cursor:pointer;
    }
    .full-item-btn:hover {
      background:#333;
    }
  </style>
</head>
<body>
  <div class="top-buttons" id="topButtons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank" rel="noopener noreferrer">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit#gid=491619272"
       target="_blank" rel="noopener noreferrer">Spreadsheet</a>
    <button type="button" id="showAllBtn">Show All (High → Low)</button>
    <button type="button" id="showHiddenBtn">Show Weapon/Mod/BP/Key/Quest/Misc Only</button>
    <button type="button" id="showDefaultBtn" class="hidden">Back to Default</button>
    <button type="button" id="notesToggle">Important Notes</button>
  </div>

  <div class="search-row">
    <input id="search" placeholder="Type item name..." autofocus>
    <button id="clear-search" type="button" aria-label="Clear search">×</button>
  </div>

  <!-- Shown only when there is text in the search box -->
  <div id="instructions" class="instructions hidden">
    <div class="instructions-title">How to read the colors</div>
    <div class="instructions-row">
      Item Rarity:
      <span class="pill pill-common">Common</span>
      <span class="pill pill-uncommon">Uncommon</span>
      <span class="pill pill-rare">Rare</span>
      <span class="pill pill-epic">Epic</span>
      <span class="pill pill-legendary">Legendary</span>
    </div>
    <div class="instructions-row">
      Sell value:
      <span class="pill pill-price-1">≤ 1000</span>
      <span class="pill pill-price-2">1001–2000</span>
      <span class="pill pill-price-3">2001–5000</span>
      <span class="pill pill-price-4">5001+</span>
    </div>
  </div>

  <!-- Important Notes (Google Sheet "Important Notes" tab) -->
  <div id="notesPanel" class="notes-panel hidden">
    <h2>Important Notes</h2>
    <div id="notesContent">Loading…</div>
  </div>

  <div id="result"></div>

  <footer>
    Data sourced via your Google Sheet and
    <a href="https://metaforge.app/arc-raiders" target="_blank" rel="noopener noreferrer">MetaForge ARC Raiders</a>.
  </footer>

<script>
"use strict";

/**
 * CONFIGURATION
 */
const MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=491619272&single=true&output=csv";

const NOTES_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=732163012&single=true&output=csv";

/**
 * Item types to hide by default in "Show All" view,
 * but expose via "Show Weapon/Mod/BP/Key/Quest/Misc Only".
 */
const HIDDEN_ITEM_TYPES = new Set([
  "weapon",
  "modifications",
  "blueprint",
  "key",
  "quest item",
  "misc"
]);

/**
 * GLOBAL STATE
 */
const state = {
  items: [],               // enabled items
  itemByName: new Map(),   // normalized name -> full item
  importantNotes: [],
  dataLoaded: false,
  notesLoaded: false,
  notesError: null,
  masterHeaders: [],       // header row strings
  colIndex: {},            // canonical header -> index (first occurrence)
  columnVisibility: []     // per-column visibility for FULL INFO (from CONFIG row)
};

// DOM cache
const dom = {
  search:        document.getElementById("search"),
  clearSearch:   document.getElementById("clear-search"),
  topButtons:    document.getElementById("topButtons"),
  instructions:  document.getElementById("instructions"),
  result:        document.getElementById("result"),
  notesPanel:    document.getElementById("notesPanel"),
  notesContent:  document.getElementById("notesContent"),
  notesToggle:   document.getElementById("notesToggle"),
  showAllBtn:    document.getElementById("showAllBtn"),
  showHiddenBtn: document.getElementById("showHiddenBtn"),
  showDefaultBtn:document.getElementById("showDefaultBtn")
};

/**
 * UTILITIES
 */

function normalizeName(str) {
  return (str || "").trim().toLowerCase();
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, ch => {
    switch (ch) {
      case "&": return "&amp;";
      case "<": return "&lt;";
      case ">": return "&gt;";
      case '"': return "&quot;";
      case "'": return "&#39;";
      default:  return ch;
    }
  });
}

/**
 * Canonicalize a header for robust matching:
 *  - lowercase
 *  - remove all non-alphanumeric characters
 */
function canonicalKey(header) {
  return (header || "")
    .toLowerCase()
    .replace(/[^a-z0-9]/g, "");
}

function csvSplit(row) {
  const out = [];
  let field = "";
  let inQuotes = false;

  for (const ch of row) {
    if (ch === '"') {
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) {
      out.push(field);
      field = "";
      continue;
    }
    field += ch;
  }
  out.push(field);
  return out;
}

function rarityColor(rarity) {
  const r = (rarity || "").toLowerCase();
  if (r.includes("uncommon"))  return "#00ff00";
  if (r.includes("rare"))      return "#00bfff";
  if (r.includes("epic"))      return "#ff00ff";
  if (r.includes("legendary")) return "#ffd700";
  return "#ffffff";
}

function priceColor(valueNum) {
  const n = Number(valueNum) || 0;
  if (n <= 1000)  return "#ffffff";
  if (n <= 2000)  return "#00ff00";
  if (n <= 5000)  return "#ff69b4";
  return "#ffd700";
}

/**
 * Parse numeric cell safely:
 *  - Keep the raw text
 *  - Try to parse a number after removing commas and spaces
 *  - If parsing fails, num = 0 but raw is preserved
 */
function parseNumericCell(raw) {
  const valueRaw = (raw || "").trim();
  if (!valueRaw) {
    return { num: 0, raw: "" };
  }

  const cleaned = valueRaw.replace(/,/g, "").replace(/\s+/g, "");
  const num = Number(cleaned);
  if (isNaN(num)) {
    return { num: 0, raw: valueRaw };
  }
  return { num, raw: valueRaw };
}

function parseRecycleEntry(entry) {
  if (!entry) return null;
  const trimmed = entry.trim();
  if (!trimmed) return null;

  const m = trimmed.match(/^\s*(\d+)\s*x?\s*(.+)$/i);
  if (!m) {
    return { qty: null, itemName: trimmed };
  }
  return {
    qty: parseInt(m[1], 10),
    itemName: m[2].trim()
  };
}

function isDisabledConfig(val) {
  if (!val) return false;
  const v = val.toLowerCase();
  return v === "0" || v === "no" || v === "false" || v === "hide" || v === "off";
}

function isColVisible(canonical) {
  const idx = state.colIndex[canonical];
  if (idx == null) return true; // if we can't find it, default to visible
  return !!state.columnVisibility[idx];
}

/**
 * Is this item's item_type one of the hidden categories (weapon, mod, etc)?
 */
function isHiddenType(item) {
  const t = normalizeName(item.itemType);
  return HIDDEN_ITEM_TYPES.has(t);
}

/**
 * DATA LOADING
 */

async function init() {
  dom.result.textContent = "Loading item data…";
  attachEventHandlers();

  try {
    const masterCsv = await fetchTextSafe(MASTER_CSV_URL);
    if (!masterCsv) {
      throw new Error("Failed to load Items_Master CSV.");
    }

    parseItemsMasterCsv(masterCsv);

    console.log("Parsed items from Items_Master (enabled):", state.items.length);

    if (!state.items.length) {
      dom.result.innerHTML =
        '<div class="error">No enabled items parsed from Items_Master. ' +
        'Check that the published CSV is the Items_Master tab and that the "name" column is filled.</div>';
      return;
    }

    state.dataLoaded = true;
    dom.result.textContent = "Type an item name above to search, or click “Show All (High → Low)”.";
  } catch (err) {
    console.error(err);
    dom.result.innerHTML =
      '<div class="error">Error loading data from Items_Master CSV. Check the published URL.</div>';
  }
}

async function fetchTextSafe(url) {
  if (!url) return null;
  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    return res.text();
  } catch {
    return null;
  }
}

/**
 * Parse Items_Master CSV into state.items.
 * Uses:
 *  - header row (row 1) for column names
 *  - optional CONFIG row (row 2) for per-column visibility in Full Info
 */
function parseItemsMasterCsv(csvText) {
  const rows = csvText.replace(/\r/g, "").split("\n");
  if (!rows.length) return;

  const headerFields = csvSplit(rows[0]).map(h => h.trim());
  console.log("Items_Master header row (raw):", headerFields);

  // Map canonical header -> FIRST index (so "value" resolves to the earliest value column)
  const colIndex = {};
  headerFields.forEach((h, i) => {
    if (!h) return;
    const key = canonicalKey(h);
    if (!key) return;
    if (colIndex[key] == null) {
      colIndex[key] = i;
    }
  });
  console.log("Items_Master header index (canonical, first-wins):", colIndex);

  state.masterHeaders = headerFields;
  state.colIndex = colIndex;
  state.columnVisibility = headerFields.map(() => true); // default: all visible in Full Info

  function getField(fields, logicalKey) {
    const idx = colIndex[logicalKey];
    return idx == null ? "" : (fields[idx] || "");
  }

  let startRow = 1;

  // Optional CONFIG row
  if (rows.length > 1) {
    const cfgFields = csvSplit(rows[1]);
    let cfgName = "";
    const nameIdx = colIndex["name"];
    if (nameIdx != null) {
      cfgName = (cfgFields[nameIdx] || "").trim();
    } else if (cfgFields.length) {
      cfgName = cfgFields[0].trim();
    }

    if (cfgName && canonicalKey(cfgName) === "config") {
      // Per-column visibility: any "0/no/false/hide/off" hides that column in Full Info
      state.columnVisibility = headerFields.map((_, i) => {
        const v = (cfgFields[i] || "").trim();
        return !isDisabledConfig(v);
      });
      startRow = 2;
    }
  }

  const items = [];
  state.itemByName.clear();

  for (let i = startRow; i < rows.length; i++) {
    const row = rows[i];
    if (!row.trim()) continue;

    const fields = csvSplit(row);

    const name = getField(fields, "name").trim();
    if (!name) continue;

    const apiId        = getField(fields, "apiid").trim() || null;
    const rarity       = getField(fields, "rarity").trim();
    const valueStrRaw  = getField(fields, "value").trim();
    const numeric      = parseNumericCell(valueStrRaw);

    const itemType     = getField(fields, "itemtype").trim();
    const workbench    = getField(fields, "workbench").trim();
    const lootArea     = getField(fields, "lootarea").trim();
    const subcategory  = getField(fields, "subcategory").trim();
    const loadoutSlots = getField(fields, "loadoutslots").trim();
    const recycle1     = getField(fields, "recycle1").trim();
    const recycle2     = getField(fields, "recycle2").trim();
    const salvage1     = getField(fields, "salvage1").trim();
    const salvage2     = getField(fields, "salvage2").trim();
    const notes        = getField(fields, "notes").trim();
    const enabledRaw   = getField(fields, "enabled").trim();
    const quest1       = getField(fields, "quest1").trim();
    const quest2       = getField(fields, "quest2").trim();
    const quest3       = getField(fields, "quest3").trim();
    const description  = getField(fields, "description").trim();
    const ammoType     = getField(fields, "ammotype").trim();
    const icon         = getField(fields, "icon").trim();
    const flavorText   = getField(fields, "flavortext").trim(); // canonical flavor_text -> flavortext

    const enabled =
      enabledRaw === "" ||
      !["false", "0", "no"].includes(enabledRaw.toLowerCase());

    const manualQuestNames = [quest1, quest2, quest3].filter(q => q);

    const item = {
      apiId,
      name,
      rarity,
      valueNum: numeric.num,
      valueRaw: numeric.raw,
      itemType,
      workbench,
      lootArea,
      subcategory,
      loadoutSlots,
      recycle1,
      recycle2,
      salvage1,
      salvage2,
      notes,
      enabled,
      manualQuestNames,
      description,
      ammoType,
      icon,
      flavorText,
      rawRow: fields // full raw row for generic Full Info dump
    };

    state.itemByName.set(normalizeName(name), item);
    if (enabled) {
      items.push(item);
    }
  }

  state.items = items;

  if (items.length) {
    console.log("Sample item numeric value/valueRaw:",
      items[0].name, items[0].valueNum, items[0].valueRaw);
  }
}

/**
 * IMPORTANT NOTES LOADING
 */

async function ensureNotesLoaded() {
  if (state.notesLoaded || state.notesError || !NOTES_CSV_URL) return;

  try {
    const text = await fetchTextSafe(NOTES_CSV_URL);
    if (!text) {
      state.notesError = "Error loading Important Notes from the spreadsheet.";
      return;
    }

    const rows = text.replace(/\r/g, "").split("\n");
    state.importantNotes = [];

    for (const row of rows) {
      if (!row.trim()) continue;
      const fields = csvSplit(row);
      const note = (fields[0] || "").trim();
      if (note) {
        state.importantNotes.push(note);
      }
    }

    state.notesLoaded = true;
  } catch (err) {
    console.error(err);
    state.notesError = "Error loading Important Notes from the spreadsheet.";
  }
}

function renderNotesPanel() {
  if (!NOTES_CSV_URL) {
    dom.notesContent.innerHTML =
      '<div class="error">NOTES_CSV_URL is not set yet. Publish your "Important Notes" tab and paste its CSV link into the script.</div>';
    return;
  }

  if (state.notesError) {
    dom.notesContent.innerHTML = '<div class="error">' + escapeHtml(state.notesError) + '</div>';
    return;
  }

  if (!state.importantNotes.length) {
    dom.notesContent.textContent = "No notes found.";
    return;
  }

  const itemsHtml = state.importantNotes
    .map(n => '<div class="note-item">• ' + escapeHtml(n) + '</div>')
    .join("");
  dom.notesContent.innerHTML = itemsHtml;
}

/**
 * SEARCH + RENDER (compact view)
 */

let searchDebounceTimer = null;

function runSearch(queryRaw) {
  const query = queryRaw.trim();
  const qNorm = normalizeName(query);

  dom.result.innerHTML = "";

  if (!state.dataLoaded) {
    dom.result.textContent = "Still loading data…";
    return;
  }

  if (!qNorm) {
    dom.result.textContent = "Type an item name above to search, or click “Show All (High → Low)”.";
    return;
  }

  const matches = state.items.filter(it =>
    normalizeName(it.name).includes(qNorm)
  );

  if (!matches.length) {
    dom.result.innerHTML = "<div>No match</div>";
    return;
  }

  matches.sort((a, b) => {
    const aName = normalizeName(a.name);
    const bName = normalizeName(b.name);
    const aStarts = aName.startsWith(qNorm) ? 0 : 1;
    const bStarts = bName.startsWith(qNorm) ? 0 : 1;
    if (aStarts !== bStarts) return aStarts - bStarts;
    return aName.localeCompare(bName);
  });

  let html = "";
  for (const item of matches) {
    html += renderItemBlock(item);
  }
  dom.result.innerHTML = html;
}

/**
 * "Show All" view – with modes:
 *  - "default": show all enabled items EXCEPT the hidden types
 *  - "hidden": show ONLY items whose type is in the hidden list
 */
function showAllItemsByValue(mode) {
  if (!state.dataLoaded) {
    dom.result.textContent = "Still loading data…";
    return;
  }

  let items = [...state.items];

  if (mode === "hidden") {
    items = items.filter(it => isHiddenType(it));
  } else {
    // default mode: hide the listed categories
    items = items.filter(it => !isHiddenType(it));
  }

  items.sort((a, b) => (b.valueNum || 0) - (a.valueNum || 0));

  dom.search.value = "";
  setInstructionsVisible(false);
  setTopButtonsVisible(true); // keep top controls visible

  if (!items.length) {
    dom.result.innerHTML = "<div>No items.</div>";
    return;
  }

  let html = "";
  for (const item of items) {
    html += renderItemBlock(item);
  }
  dom.result.innerHTML = html;
}

function renderItemBlock(item) {
  const rarityClr = rarityColor(item.rarity);

  const valueNum = item.valueNum || 0;
  let valueText = "";
  if (valueNum) {
    valueText = valueNum.toLocaleString("en-US");
  } else if (item.valueRaw) {
    valueText = item.valueRaw;
  }
  const valueClr = priceColor(valueNum);

  const itemUrl = item.apiId
    ? "https://metaforge.app/arc-raiders/database/item/" + encodeURIComponent(item.apiId)
    : null;

  const recycledFrom = findRecyclersForItem(item.name);
  const manualQuestTagHtml = renderManualQuestTags(item.manualQuestNames);

  let html = '<div class="item-block">';

  // Title line
  html += '<div class="item-title">';
  let titleInner = "";

  if (itemUrl) {
    titleInner += '<a class="item-link" href="' + itemUrl +
                  '" target="_blank" rel="noopener noreferrer">' +
                  '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>" +
                  "</a>";
  } else {
    titleInner += '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>";
  }

  if (valueText) {
    titleInner += '<span class="item-value" style="color:' + valueClr + ';"> — ' +
                  escapeHtml(valueText) + "</span>";
  }

  if (manualQuestTagHtml) {
    titleInner += " " + manualQuestTagHtml;
  }

  html += titleInner;

  // Full Info button
  html += '<button type="button" class="full-item-btn" data-item-name="' +
          escapeHtml(item.name) + '">Full Info</button>';

  html += "</div>";

  // Notes at top, red (always shown in compact view)
  if (item.notes) {
    html += '<div class="line" style="color:#ff6666;"><strong>Notes:</strong> ' +
            escapeHtml(item.notes) + "</div>";
  }

  // Recycles To
  const recToParts = [];
  if (item.recycle1) recToParts.push(item.recycle1);
  if (item.recycle2) recToParts.push(item.recycle2);

  if (recToParts.length) {
    html += '<div class="line">Recycles To: ' +
            recToParts.map(escapeHtml).join(", ") + "</div>";
  }

  // Recycled From
  if (recycledFrom.length) {
    html += '<div class="line" style="color:#ffa500;">Recycled From: ' +
            '<span class="line-small">R = Recycled, S = Salvaged</span>' +
            "</div>";

    for (const src of recycledFrom) {
      const rarityClrSrc = rarityColor(src.rarity);

      const srcValueNum = src.valueNum || 0;
      let srcValueText = "";
      if (srcValueNum) {
        srcValueText = srcValueNum.toLocaleString("en-US");
      } else if (src.valueRaw) {
        srcValueText = src.valueRaw;
      }
      const srcValueColor = priceColor(srcValueNum);

      const srcManualQuestTag = renderManualQuestTags(src.manualQuestNames);

      const rsParts = [];
      if (src.qty !== null) rsParts.push("R-" + src.qty);
      if (src.salvageQty != null) rsParts.push("S-" + src.salvageQty);

      html += '<div class="line">';
      html += '<span class="rarity-prefix" style="color:' + rarityClrSrc + ';">-</span>';
      html += '<span style="color:#ffffff; font-weight:bold;">' +
              escapeHtml(src.name) + "</span>";
      if (rsParts.length) {
        html += ' <span class="line-small">' + rsParts.join(" · ") + "</span>";
      }
      if (srcValueText) {
        html += ' — <span style="color:' + srcValueColor +
                '; font-weight:bold;">' + escapeHtml(srcValueText) + "</span>";
      }
      if (srcManualQuestTag) {
        html += " " + srcManualQuestTag;
      }
      html += "</div>";
    }
  }

  html += "<hr></div>";
  return html;
}

function renderManualQuestTags(questNames) {
  if (!questNames || !questNames.length) return "";
  const parts = questNames.map(q => escapeHtml(q));
  return '<span class="quest-tag">[Needed for: ' + parts.join(", ") + "]</span>";
}

function findRecyclersForItem(targetName) {
  const targetKey = normalizeName(targetName);
  const results = [];

  for (const item of state.items) {
    const entries = [item.recycle1, item.recycle2];
    let totalQty = 0;
    let hasMatch = false;

    for (const entry of entries) {
      const parsed = parseRecycleEntry(entry);
      if (!parsed) continue;
      const entryKey = normalizeName(parsed.itemName);
      if (!entryKey || entryKey !== targetKey) continue;

      hasMatch = true;
      if (parsed.qty) totalQty += parsed.qty;
    }

    if (hasMatch) {
      results.push({
        name: item.name,
        rarity: item.rarity,
        valueNum: item.valueNum,
        valueRaw: item.valueRaw,
        manualQuestNames: item.manualQuestNames,
        qty: totalQty || null,
        salvageQty: null
      });
    }
  }

  return results;
}

/**
 * FULL ITEM LOOKUP (uses all columns, controlled by CONFIG row)
 */

function fullItemLookupByName(name) {
  if (!state.dataLoaded) {
    dom.result.textContent = "Still loading data…";
    return;
  }

  const key = normalizeName(name);
  const item = state.itemByName.get(key);

  if (!item) {
    dom.result.innerHTML =
      '<div class="error">No item found in Items_Master for "' + escapeHtml(name) + '".</div>';
    return;
  }

  dom.result.innerHTML = renderFullItemDetailsFromMaster(item);
  setInstructionsVisible(false);
}

function renderFullItemDetailsFromMaster(item) {
  const rarityClr = rarityColor(item.rarity);

  const valueNum = item.valueNum || 0;
  let valueText = "";
  if (valueNum) {
    valueText = valueNum.toLocaleString("en-US");
  } else if (item.valueRaw) {
    valueText = item.valueRaw;
  }
  const valueClr = priceColor(valueNum);

  const itemUrl = item.apiId
    ? "https://metaforge.app/arc-raiders/database/item/" + encodeURIComponent(item.apiId)
    : null;

  const headers = state.masterHeaders;
  const colVis  = state.columnVisibility;

  let html = '<div class="item-block">';

  // Title
  html += '<div class="item-title">';
  if (itemUrl) {
    html += '<a class="item-link" href="' + itemUrl +
            '" target="_blank" rel="noopener noreferrer">' +
            '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>" +
            "</a>";
  } else {
    html += '<span style="color:' + rarityClr + ';">' + escapeHtml(item.name) + "</span>";
  }
  if (valueText) {
    html += '<span class="item-value" style="color:' + valueClr + ';"> — ' +
            escapeHtml(valueText) + "</span>";
  }
  html += "</div>";

  // Notes at top, red (honor column visibility if "notes" is disabled)
  if (isColVisible("notes") && item.notes) {
    html += '<div class="line-small" style="color:#ff6666;"><strong>Notes:</strong> ' +
            escapeHtml(item.notes) + "</div>";
  }

  // Core meta lines, respecting column visibility
  if (isColVisible("apiid") && item.apiId) {
    html += '<div class="line-small"><strong>API ID:</strong> ' +
            escapeHtml(String(item.apiId)) + "</div>";
  }
  if (isColVisible("rarity") && item.rarity) {
    html += '<div class="line-small"><strong>Rarity:</strong> ' +
            escapeHtml(item.rarity) + "</div>";
  }

  // Item category (Type): hide if blank or "0"
  const hasCategory = item.itemType && item.itemType.trim() !== "" && item.itemType.trim() !== "0";
  if (isColVisible("itemtype") && hasCategory) {
    html += '<div class="line-small"><strong>Type:</strong> ' +
            escapeHtml(item.itemType) + "</div>";
  }

  if (isColVisible("workbench") && item.workbench) {
    html += '<div class="line-small"><strong>Workbench:</strong> ' +
            escapeHtml(item.workbench) + "</div>";
  }
  if (isColVisible("lootarea") && item.lootArea) {
    html += '<div class="line-small"><strong>Loot Area:</strong> ' +
            escapeHtml(item.lootArea) + "</div>";
  }
  if (isColVisible("subcategory") && item.subcategory) {
    html += '<div class="line-small"><strong>Subcategory:</strong> ' +
            escapeHtml(item.subcategory) + "</div>";
  }
  if (isColVisible("loadoutslots") && item.loadoutSlots) {
    html += '<div class="line-small"><strong>Loadout Slots:</strong> ' +
            escapeHtml(item.loadoutSlots) + "</div>";
  }
  if (isColVisible("ammotype") && item.ammoType) {
    html += '<div class="line-small"><strong>Ammo Type:</strong> ' +
            escapeHtml(item.ammoType) + "</div>";
  }
  if (isColVisible("description") && item.description) {
    html += '<div class="line-small"><strong>Description:</strong> ' +
            escapeHtml(item.description) + "</div>";
  }
  if (isColVisible("flavortext") && item.flavorText) {
    html += '<div class="line-small"><strong>Flavor Text:</strong> ' +
            escapeHtml(item.flavorText) + "</div>";
  }
  if (isColVisible("icon") && item.icon) {
    html += '<div class="line-small"><strong>Icon:</strong> ' +
            '<a href="' + escapeHtml(item.icon) +
            '" target="_blank" rel="noopener noreferrer">Open icon</a></div>';
  }

  // Recycles / Salvage combined lines, honoring visibility
  const showRecycle =
    (isColVisible("recycle1") || isColVisible("recycle2")) &&
    (item.recycle1 || item.recycle2);

  if (showRecycle) {
    const recParts = [];
    if (item.recycle1) recParts.push(item.recycle1);
    if (item.recycle2) recParts.push(item.recycle2);
    html += '<div class="line-small"><strong>Recycles To:</strong> ' +
            recParts.map(escapeHtml).join(", ") + "</div>";
  }

  const showSalvage =
    (isColVisible("salvage1") || isColVisible("salvage2")) &&
    (item.salvage1 || item.salvage2);

  if (showSalvage) {
    const salvParts = [];
    if (item.salvage1) salvParts.push(item.salvage1);
    if (item.salvage2) salvParts.push(item.salvage2);
    html += '<div class="line-small"><strong>Salvages To:</strong> ' +
            salvParts.map(escapeHtml).join(", ") + "</div>";
  }

  const showQuests =
    (isColVisible("quest1") || isColVisible("quest2") || isColVisible("quest3")) &&
    item.manualQuestNames.length;

  if (showQuests) {
    html += '<div class="line-small"><strong>Needed for:</strong> ' +
            escapeHtml(item.manualQuestNames.join(", ")) + "</div>";
  }

  // Generic dump for ALL remaining columns
  const skipCanonicals = new Set([
    "apiid",
    "name",
    "rarity",
    "value",
    "itemtype",
    "workbench",
    "lootarea",
    "subcategory",
    "loadoutslots",
    "recycle1",
    "recycle2",
    "salvage1",
    "salvage2",
    "notes",
    "enabled",
    "quest1",
    "quest2",
    "quest3",
    "description",
    "ammotype",
    "icon",
    "flavortext"
  ]);

  const row = item.rawRow || [];

  for (let i = 0; i < headers.length; i++) {
    const header = headers[i];
    if (!header) continue;

    // Column visibility from CONFIG row
    if (!colVis[i]) continue;

    const canon = canonicalKey(header);
    if (skipCanonicals.has(canon)) continue; // already handled above

    const val = row[i];
    if (val == null || String(val).trim() === "") continue;

    html += '<div class="line-small"><strong>' +
            escapeHtml(header) + ':</strong> ' +
            escapeHtml(String(val)) + "</div>";
  }

  html += "</div>";
  return html;
}

/**
 * UI HANDLERS
 */

function attachEventHandlers() {
  dom.search.addEventListener("input", () => {
    const value = dom.search.value;

    if (!value.trim()) {
      dom.result.textContent = "Type an item name above to search, or click “Show All (High → Low)”.";
      setTopButtonsVisible(true);
      setInstructionsVisible(false);
      return;
    }

    setTopButtonsVisible(false);
    setInstructionsVisible(true);

    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      runSearch(value);
    }, 120);
  });

  dom.search.addEventListener("focus", () => {
    if (dom.search.value) {
      dom.search.value = "";
    }
    dom.result.textContent = "Type an item name above to search, or click “Show All (High → Low)”.";
    setTopButtonsVisible(true);
    setInstructionsVisible(false);
  });

  dom.clearSearch.addEventListener("click", () => {
    dom.search.value = "";
    dom.search.focus();
    dom.result.textContent = "Type an item name above to search, or click “Show All (High → Low)”.";
    setTopButtonsVisible(true);
    setInstructionsVisible(false);
  });

  dom.notesToggle.addEventListener("click", async () => {
    const isHidden = dom.notesPanel.classList.contains("hidden");
    if (isHidden) {
      await ensureNotesLoaded();
      renderNotesPanel();
      dom.notesPanel.classList.remove("hidden");
    } else {
      dom.notesPanel.classList.add("hidden");
    }
  });

  // Show all (default: hide Weapons/Mods/BP/Key/Quest/Misc)
  dom.showAllBtn.addEventListener("click", () => {
    showAllItemsByValue("default");
    dom.showDefaultBtn.classList.add("hidden");
  });

  // Show ONLY Weapons/Mods/BP/Key/Quest/Misc
  dom.showHiddenBtn.addEventListener("click", () => {
    showAllItemsByValue("hidden");
    dom.showDefaultBtn.classList.remove("hidden");
  });

  // Back to default filtered view (non-hidden types)
  dom.showDefaultBtn.addEventListener("click", () => {
    showAllItemsByValue("default");
    dom.showDefaultBtn.classList.add("hidden");
  });

  // Full Info button (event delegation)
  dom.result.addEventListener("click", (event) => {
    const btn = event.target.closest(".full-item-btn");
    if (!btn) return;
    const itemName = btn.getAttribute("data-item-name") || "";
    fullItemLookupByName(itemName);
  });
}

function setTopButtonsVisible(visible) {
  if (visible) dom.topButtons.classList.remove("hidden");
  else dom.topButtons.classList.add("hidden");
}

function setInstructionsVisible(visible) {
  if (visible) dom.instructions.classList.remove("hidden");
  else dom.instructions.classList.add("hidden");
}

/**
 * BOOTSTRAP
 */
init();
</script>
</body>
</html>
