<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>

<script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

<style>
body{
  background:#000;color:#fff;font-family:Segoe UI,sans-serif;
  padding:20px;max-width:1100px;margin:0 auto
}
.top-bar{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:12px
}
.top-buttons{
  display:flex;gap:10px;flex-wrap:wrap
}
.top-buttons a,.top-buttons button{
  background:#222;color:#fff;border:1px solid #444;border-radius:6px;
  padding:6px 12px;cursor:pointer;text-decoration:none
}
.top-buttons a:hover,.top-buttons button:hover{background:#333}

.status{font-size:12px;font-weight:bold}
.status.loading{color:#ff5555}
.status.loaded{color:#33cc66}
.status.error{color:#ff9933}

.search-row{display:flex;gap:8px;margin-bottom:8px}
#search{flex:1;font-size:22px;padding:12px}
#clear-search{
  padding:10px 14px;font-size:18px;background:#222;color:#fff;
  border:1px solid #444;border-radius:6px;cursor:pointer
}

.all-filters{
  display:none;gap:8px;flex-wrap:wrap;margin:10px 0 14px
}
.all-filters button{
  background:#222;color:#fff;border:1px solid #444;border-radius:6px;
  padding:6px 10px;cursor:pointer
}
.all-filters button.active{background:#444}

.item-block{margin:12px 0 18px}
.item-title{
  font-size:26px;font-weight:bold;display:flex;gap:10px;
  flex-wrap:wrap;align-items:center
}
.item-title a{text-decoration:none}
.item-value{font-size:20px}
.btn-small{
  background:#222;border:1px solid #444;color:#fff;border-radius:6px;
  padding:4px 10px;font-size:12px;cursor:pointer
}

.line{margin:4px 0;font-size:18px}
.line-small{font-size:14px;color:#ccc}
.quest-tag{color:#ffd700;margin-left:6px}
hr{border:1px solid #333;margin:12px 0}

/* Workshops */
.view-title{
  font-size:28px;font-weight:bold;text-align:center;margin-bottom:20px
}
.section-header{
  font-size:24px;
  font-weight:bold;
  color:#33cc66;              /* green */
  text-align:center;          /* centered */
  margin:36px 0 12px;         /* more space above */
  border-bottom:1px solid #444;
  padding-bottom:6px
}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{
  border-bottom:1px solid #333;
  padding:12px;
  vertical-align:top
}
th{color:#ffd700;text-align:left}
tr{height:48px}

.clickable{cursor:pointer;text-decoration:underline}
.clickable:hover{color:#00bfff}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit" target="_blank">Spreadsheet</a>
    <button id="workshopsBtn">Workshops</button>
    <button id="showAllBtn">Show All</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<div class="all-filters" id="filters">
  <button data-filter="__other__" class="active">Everything else</button>
  <button data-filter="Weapon">Weapon</button>
  <button data-filter="Modification">Modification</button>
  <button data-filter="Blueprint">Blueprint</button>
  <button data-filter="Key">Key</button>
  <button data-filter="Quest Item">Quest Item</button>
  <button data-filter="Misc">Misc</button>
  <button data-filter="all">All (High → Low)</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-15
   - Header normalization fixed.
   - Full item info restored.

   2025-12-16
   - Added crafting system and workshops.

   2025-12-17
   - Fixed Show All rendering regression.
   - Restored filter pipeline.

   2025-12-18
   - Default filter set to Everything else.

   2025-12-19
   - Full Info now renders all non-hidden, non-empty columns.
   - Recycles To / Crafts To always visible.

   2025-12-20
   - Workshops section headers centered and colored green.
   - Added crafted item click → jump to item page.
   - Added ingredient click → auto-search.
   - Added sessionStorage CSV caching for stability and performance.
*/

/* ================= CONFIG ================= */
const ITEMS_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ================= STATE ================= */
const state={
  headers:[],configRow:[],items:[],expanded:new Set(),
  craftingRows:[],craftsByIngredient:new Map(),
  knownTypes:new Set(["weapon","modification","blueprint","key","quest item","misc"]),
  view:"search",filter:"__other__"
};

/* ================= HELPERS ================= */
const canon=s=>(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
const norm=s=>(s||"").trim().toLowerCase();

function rarityColor(r){
  r=(r||"").toLowerCase();
  if(r.includes("legendary"))return"#ffd700";
  if(r.includes("epic"))return"#ff00ff";
  if(r.includes("rare"))return"#00bfff";
  if(r.includes("uncommon"))return"#00ff00";
  return"#fff";
}
function priceColor(v){
  v=Number(String(v||"").replace(/,/g,""))||0;
  if(v<=1000)return"#fff";
  if(v<=2000)return"#00ff00";
  if(v<=5000)return"#ff69b4";
  return"#ffd700";
}
function escapeHtml(s){
  return(String(s||"")).replace(/[&<>"']/g,c=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]
  ));
}

/* ================= CSV + CACHE ================= */
function parseCsv(t){
  const r=[];let row=[],f="",q=false;
  for(let i=0;i<t.length;i++){
    const c=t[i],n=t[i+1];
    if(c=='"'&&q&&n=='"'){f+='"';i++}
    else if(c=='"')q=!q;
    else if(c==","&&!q){row.push(f);f=""}
    else if((c=="\n"||c=="\r")&&!q){
      if(row.length||f)r.push([...row,f]);
      row=[];f=""
    }else f+=c
  }
  if(row.length||f)r.push([...row,f]);
  return r
}

async function fetchCsvCached(url,key){
  const cached=sessionStorage.getItem(key);
  if(cached){
    try{return JSON.parse(cached)}catch{}
  }
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok)throw new Error("CSV load failed");
  const parsed=parseCsv(await res.text());
  sessionStorage.setItem(key,JSON.stringify(parsed));
  return parsed;
}

/* ================= LOADERS ================= */
async function loadItems(){
  const rows=await fetchCsvCached(ITEMS_CSV,"items_csv");
  state.headers=rows.shift();state.configRow=rows.shift();
  const hc=state.headers.map(canon),idx=h=>hc.indexOf(canon(h));
  state.items=rows.filter(r=>r[idx("name")]).map(r=>({
    row:r,name:r[idx("name")],key:norm(r[idx("name")]),
    value:r[idx("value")],rarity:r[idx("rarity")]||"",
    apiId:r[idx("apiid")]||"",itemType:r[idx("itemtype")]||"",
    recycle:[r[idx("recycle1")],r[idx("recycle2")]].filter(Boolean),
    salvage:[r[idx("salvage1")],r[idx("salvage2")]].filter(Boolean)
  }));
}

async function loadCrafting(){
  const rows=await fetchCsvCached(CRAFTING_CSV,"crafting_csv");
  const h=rows.shift().map(canon),idx=x=>h.indexOf(canon(x));
  for(const r of rows){
    const item=r[idx("itemcrafted")];if(!item)continue;
    const obj={
      itemCrafted:item,craftedAt:r[idx("craftedat")],
      category:r[idx("category")]||"",level:r[idx("level")]||"",
      ings:[r[idx("ingredient1")],r[idx("ingredient2")],r[idx("ingredient3")]].filter(Boolean)
    };
    state.craftingRows.push(obj);
    obj.ings.forEach(i=>{
      const k=norm(i.replace(/×.*$/,""));
      if(!state.craftsByIngredient.has(k))state.craftsByIngredient.set(k,[]);
      state.craftsByIngredient.get(k).push(item);
    });
  }
}

/* ================= WORKSHOPS ================= */
function renderWorkshops(){
  state.view="workshops";document.getElementById("filters").style.display="none";
  let html=`<div class="view-title">Workshops</div>`;
  const g={};
  state.craftingRows.forEach(r=>{
    if(!g[r.craftedAt])g[r.craftedAt]=[];
    g[r.craftedAt].push(r);
  });
  Object.keys(g).sort().forEach(k=>{
    html+=`<div class="section-header">${escapeHtml(k)}</div><table><thead>
      <tr><th>Item Crafted</th><th>Category</th><th>Ingredients</th><th>Workshop Level</th></tr>
    </thead><tbody>`;
    g[k].forEach(r=>{
      html+=`<tr>
        <td class="clickable" data-jump="${escapeHtml(r.itemCrafted)}">${escapeHtml(r.itemCrafted)}</td>
        <td>${escapeHtml(r.category)}</td>
        <td>${r.ings.map(i=>`<div class="clickable" data-search="${escapeHtml(i.replace(/×.*$/,""))}">${escapeHtml(i)}</div>`).join("")}</td>
        <td>${escapeHtml(r.level)}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
  });
  document.getElementById("result").innerHTML=html;
}

/* ================= EVENTS ================= */
document.getElementById("workshopsBtn").onclick=renderWorkshops;

document.getElementById("result").onclick=e=>{
  const j=e.target.closest("[data-jump]");
  if(j){
    document.getElementById("search").value=j.dataset.jump;
    state.view="search";
    renderSearch(j.dataset.jump);
    return;
  }
  const s=e.target.closest("[data-search]");
  if(s){
    document.getElementById("search").value=s.dataset.search;
    state.view="search";
    renderSearch(s.dataset.search);
  }
};

/* ================= BOOT ================= */
async function init(){
  try{
    await loadItems();
    await loadCrafting();
    document.getElementById("status").textContent="Loaded";
    document.getElementById("status").className="status loaded";
  }catch(e){
    console.error(e);
    document.getElementById("status").textContent="Error";
    document.getElementById("status").className="status error";
  }
}
init();
</script>

</body>
</html>
