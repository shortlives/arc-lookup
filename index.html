<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>

<script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

<style>
  body{background:#000;color:#fff;font-family:Segoe UI,sans-serif;padding:20px;max-width:1100px;margin:0 auto}
  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .top-buttons{display:flex;gap:10px;flex-wrap:wrap}
  .top-buttons a,.top-buttons button{background:#222;color:#fff;border:1px solid #444;border-radius:6px;padding:6px 12px;cursor:pointer;text-decoration:none}
  .top-buttons a:hover,.top-buttons button:hover{background:#333}
  .status{font-size:12px;font-weight:bold;white-space:nowrap}
  .status.loading{color:#ff5555}.status.loaded{color:#33cc66}.status.error{color:#ff9933}

  .search-row{display:flex;gap:8px;margin-bottom:8px}
  #search{flex:1;font-size:22px;padding:12px}
  #clear-search{padding:10px 14px;font-size:18px;background:#222;color:#fff;border:1px solid #444;border-radius:6px;cursor:pointer}
  #clear-search:hover{background:#333}

  .all-filters{display:none;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
  .all-filters button{background:#222;color:#fff;border:1px solid #444;border-radius:6px;padding:6px 10px;cursor:pointer}
  .all-filters button.active{background:#444;border-color:#666}

  .item-block{margin:12px 0 18px}
  .item-title{font-size:26px;font-weight:bold;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .item-title a{text-decoration:none}
  .item-value{font-size:20px}
  .btn-small{background:#222;border:1px solid #444;color:#fff;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer}
  .btn-small:hover{background:#333}
  .line{margin:4px 0;font-size:18px}
  .line-small{font-size:14px;color:#ccc}
  .quest-tag{color:#ffd700;margin-left:6px}
  hr{border:1px solid #333;margin:12px 0}

  .view-title{font-size:26px;font-weight:bold;margin:6px 0 12px}
  .section-header{font-size:22px;font-weight:bold;margin-top:18px;border-bottom:1px solid #444;padding-bottom:6px}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #333;padding:12px;vertical-align:top}
  th{color:#ffd700;text-align:left}
  tr{height:44px}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank" rel="noopener noreferrer">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit" target="_blank" rel="noopener noreferrer">Spreadsheet</a>
    <button id="workshopsBtn" type="button">Workshops</button>
    <button id="showAllBtn" type="button">Show All</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search" type="button" aria-label="Clear search">×</button>
</div>

<!-- Everything else far-left and default; All is after Quest Item -->
<div class="all-filters" id="filters">
  <button data-filter="__other__" class="active">Everything else</button>
  <button data-filter="Weapon">Weapon</button>
  <button data-filter="Modification">Modification</button>
  <button data-filter="Blueprint">Blueprint</button>
  <button data-filter="Key">Key</button>
  <button data-filter="Quest Item">Quest Item</button>
  <button data-filter="Misc">Misc</button>
  <button data-filter="all">All (High → Low)</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-15
   - Header normalization fixed.
   - Full item info restored.

   2025-12-16
   - Added crafting system and workshops.

   2025-12-17
   - Fixed Show All rendering regression.
   - Restored filter pipeline.
   - Restored Full Info toggle render path.

   2025-12-18
   - Moved "Everything else" to default filter.
   - Restored Workshops rendering.

   2025-12-19
   - FIXED: Full Info now iterates all columns.
   - Respects config row hide semantics.
   - Skips empty and zero values only.
   - Recycles To and Crafts To always visible.

   2025-12-17 (APPEND)
   - FIXED: Rarity and value colors were not being applied in the render path.
     Reason: item HTML was missing rarityColor()/priceColor() usage and inline styles.
   - FIXED: Workshops button did nothing.
     Reason: missing click handler + crafting rows not stored for grouped table output.
   - ADDED: Workshops table view grouped by Crafted At with clearer spacing.
   - ADDED: Explicit error banner when 0 Items are loaded for the main system.
*/

/* ================= CONFIG ================= */
const ITEMS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ================= DOM ================= */
const dom = {
  result: document.getElementById("result"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  status: document.getElementById("status"),
  showAll: document.getElementById("showAllBtn"),
  workshops: document.getElementById("workshopsBtn"),
  filters: document.getElementById("filters")
};

/* ================= STATE ================= */
const state = {
  // items sheet
  headers: [],
  configRow: [],
  items: [],
  expanded: new Set(),

  // crafting sheet
  craftingRows: [],             // full rows for workshops view
  craftsByIngredient: new Map(),// ingredient -> [craftedItem, craftedItem...]
  knownTypes: new Set(["weapon","modification","blueprint","key","quest item","misc"]),

  // view
  view: "search",               // "search" | "all" | "workshops"
  filter: "__other__"
};

/* ================= HELPERS ================= */
const canon = s => (s || "").toLowerCase().replace(/[^a-z0-9]/g, "");
const norm = s => (s || "").trim().toLowerCase();

function escapeHtml(str){
  return (str || "").replace(/[&<>"']/g, ch => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[ch]));
}

function setStatus(text, kind){
  dom.status.textContent = text;
  dom.status.className = `status ${kind}`;
}

function rarityColor(r){
  const s = (r || "").toLowerCase();
  if (s.includes("legendary")) return "#ffd700";
  if (s.includes("epic")) return "#ff00ff";
  if (s.includes("rare")) return "#00bfff";
  if (s.includes("uncommon")) return "#00ff00";
  return "#ffffff";
}

function priceColor(raw){
  const v = Number(String(raw || "").replace(/,/g,"")) || 0;
  if (v <= 1000) return "#ffffff";
  if (v <= 2000) return "#00ff00";
  if (v <= 5000) return "#ff69b4";
  return "#ffd700";
}

function isHiddenByConfig(i){
  const v = (state.configRow[i] || "").toLowerCase().trim();
  return v === "hide" || v === "false" || v === "0" || v === "no";
}

function isMeaningful(v){
  if (v == null) return false;
  const s = String(v).trim();
  if (!s) return false;
  const n = Number(s.replace(/,/g,""));
  if (!isNaN(n) && n === 0) return false;
  return true;
}

/* Ingredient cell like "Plastic Parts ×2" => ("plastic parts", "Plastic Parts ×2") */
function ingredientKey(cell){
  const s = String(cell || "").trim();
  if (!s) return "";
  return norm(s.replace(/\s*×\s*\d+\s*$/i, ""));
}

/* ================= CSV ================= */
function parseCsv(t){
  const rows = [];
  let row = [];
  let field = "";
  let inQuotes = false;

  for (let i = 0; i < t.length; i++){
    const c = t[i];
    const n = t[i+1];

    if (c === '"' && inQuotes && n === '"'){ field += '"'; i++; }
    else if (c === '"'){ inQuotes = !inQuotes; }
    else if (c === "," && !inQuotes){ row.push(field); field = ""; }
    else if ((c === "\n" || c === "\r") && !inQuotes){
      if (row.length || field){ rows.push([...row, field]); }
      row = []; field = "";
    } else field += c;
  }
  if (row.length || field) rows.push([...row, field]);
  return rows;
}

async function loadCsv(url){
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`CSV load failed: HTTP ${res.status}`);
  return parseCsv(await res.text());
}

/* ================= LOADERS ================= */
async function loadItems(){
  const rows = await loadCsv(ITEMS_CSV);
  state.headers = (rows.shift() || []).map(s => String(s || "").trim());
  state.configRow = (rows.shift() || []);

  const headersCanon = state.headers.map(canon);
  const idx = h => headersCanon.indexOf(canon(h));

  const iName = idx("name");
  const iEnabled = idx("enabled");
  const iValue = idx("value");
  const iRarity = idx("rarity");
  const iApiId = idx("apiid");
  const iType = idx("itemtype");

  // If required columns are missing, fail loudly.
  for (const [k, v] of [["name", iName], ["enabled", iEnabled], ["value", iValue]]){
    if (v < 0) throw new Error(`Items CSV missing required column: ${k}`);
  }

  state.items = rows
    .filter(r => String(r[iName] || "").trim())
    .filter(r => {
      const enabledRaw = String(r[iEnabled] || "").trim().toLowerCase();
      return !["false","0","no","hide"].includes(enabledRaw);
    })
    .map(r => ({
      row: r,
      name: String(r[iName] || "").trim(),
      key: norm(r[iName]),
      value: String(r[iValue] || "").trim(),
      rarity: iRarity >= 0 ? String(r[iRarity] || "").trim() : "",
      apiId: iApiId >= 0 ? String(r[iApiId] || "").trim() : "",
      itemType: iType >= 0 ? String(r[iType] || "").trim() : "",
      // keep these canonical lookups for quick display
      recycle: [r[idx("recycle1")], r[idx("recycle2")]].map(x => String(x || "").trim()).filter(Boolean),
      salvage: [r[idx("salvage1")], r[idx("salvage2")]].map(x => String(x || "").trim()).filter(Boolean),
      notes: String(r[idx("notes")] || "").trim(),
      quest: [r[idx("quest1")], r[idx("quest2")], r[idx("quest3")]].map(x => String(x || "").trim()).filter(Boolean)
    }));

  if (!state.items.length){
    throw new Error("[LOAD ERROR] 0 enabled items loaded from Items CSV. To fix: Click on Spreadsheet button at top, go to CSV tab. It should be working now.");
  }
}

async function loadCrafting(){
  const rows = await loadCsv(CRAFTING_CSV);
  const headers = (rows.shift() || []).map(canon);
  const idx = h => headers.indexOf(canon(h));

  const iCrafted = idx("itemcrafted");
  const iIng1 = idx("ingredient1");
  const iIng2 = idx("ingredient2");
  const iIng3 = idx("ingredient3");
  const iCategory = idx("category");
  const iCraftedAt = idx("craftedat");
  const iLevel = idx("level");

  if (iCrafted < 0 || iCraftedAt < 0){
    throw new Error("Crafting CSV missing required columns (Item Crafted / Crafted At).");
  }

  state.craftingRows = [];
  state.craftsByIngredient.clear();

  for (const r of rows){
    const crafted = String(r[iCrafted] || "").trim();
    if (!crafted) continue;

    const rowObj = {
      itemCrafted: crafted,
      category: iCategory >= 0 ? String(r[iCategory] || "").trim() : "",
      craftedAt: String(r[iCraftedAt] || "").trim(),
      level: iLevel >= 0 ? String(r[iLevel] || "").trim() : "",
      ing1: iIng1 >= 0 ? String(r[iIng1] || "").trim() : "",
      ing2: iIng2 >= 0 ? String(r[iIng2] || "").trim() : "",
      ing3: iIng3 >= 0 ? String(r[iIng3] || "").trim() : ""
    };

    state.craftingRows.push(rowObj);

    for (const ing of [rowObj.ing1, rowObj.ing2, rowObj.ing3]){
      const k = ingredientKey(ing);
      if (!k) continue;
      if (!state.craftsByIngredient.has(k)) state.craftsByIngredient.set(k, []);
      state.craftsByIngredient.get(k).push(rowObj.itemCrafted);
    }
  }
}

/* ================= RENDER: ITEMS ================= */
function renderFullInfo(it){
  // Per requirement: show every column that is NOT hidden in config row,
  // and value is not empty / not 0. (No hardcoded skip list.)
  let html = `<div class="line"><span class="line-small">Full Info:</span></div>`;
  for (let i = 0; i < state.headers.length; i++){
    if (isHiddenByConfig(i)) continue;
    const header = state.headers[i];
    const val = (it.row[i] ?? "");
    if (!isMeaningful(val)) continue;
    html += `<div class="line"><strong>${escapeHtml(header)}:</strong> ${escapeHtml(String(val).trim())}</div>`;
  }
  return html;
}

function renderItem(it){
  const expanded = state.expanded.has(it.key);
  const rarityClr = rarityColor(it.rarity);
  const valueClr = priceColor(it.value);

  const valueText = it.value ? escapeHtml(it.value) : "";
  const nameHtml = `<span style="color:${rarityClr};">${escapeHtml(it.name)}</span>`;

  const link = it.apiId
    ? `https://metaforge.app/arc-raiders/database/item/${encodeURIComponent(it.apiId)}`
    : "";

  const crafts = state.craftsByIngredient.get(it.key) || [];

  let html = `<div class="item-block">`;

  html += `<div class="item-title">`;
  html += link
    ? `<a href="${link}" target="_blank" rel="noopener noreferrer">${nameHtml}</a>`
    : nameHtml;

  if (valueText){
    html += `<span class="item-value" style="color:${valueClr};">— ${valueText}</span>`;
  }

  if (it.quest.length){
    html += `<span class="quest-tag">[${it.quest.map(escapeHtml).join(", ")}]</span>`;
  }

  html += `<button class="btn-small" type="button" data-toggle="${escapeHtml(it.key)}">${expanded ? "Hide" : "Full"} Info</button>`;
  html += `</div>`;

  if (it.notes){
    html += `<div class="line" style="color:#ff6666;"><strong>Notes:</strong> ${escapeHtml(it.notes)}</div>`;
  }

  if (it.recycle.length){
    html += `<div class="line"><strong>Recycles To:</strong> ${it.recycle.map(escapeHtml).join(", ")}</div>`;
  }
  if (it.salvage.length){
    html += `<div class="line"><strong>Salvages To:</strong> ${it.salvage.map(escapeHtml).join(", ")}</div>`;
  }

  // Per requirement: Crafts To always visible (no Full Info click).
  if (crafts.length){
    // de-dupe while preserving order
    const seen = new Set();
    const uniq = crafts.filter(x => { const k = norm(x); if (seen.has(k)) return false; seen.add(k); return true; });
    html += `<div class="line"><strong>Crafts To:</strong> ${uniq.map(escapeHtml).join(", ")}</div>`;
  }

  if (expanded){
    html += renderFullInfo(it);
  }

  html += `<hr></div>`;
  return html;
}

function renderList(list){
  dom.result.innerHTML = list.map(renderItem).join("");
}

/* ================= RENDER: ALL MODE ================= */
function setActiveFilterButton(filter){
  dom.filters.querySelectorAll("button[data-filter]").forEach(b => {
    b.classList.toggle("active", (b.dataset.filter || "") === filter);
  });
}

function computeAllList(){
  let list = [...state.items];
  const f = state.filter;

  if (f !== "all"){
    if (f === "__other__"){
      list = list.filter(it => !state.knownTypes.has(String(it.itemType || "").trim().toLowerCase()));
    } else {
      const want = String(f || "").trim().toLowerCase();
      list = list.filter(it => String(it.itemType || "").trim().toLowerCase() === want);
    }
  }

  list.sort((a,b) => {
    const av = Number(String(a.value||"").replace(/,/g,"")) || 0;
    const bv = Number(String(b.value||"").replace(/,/g,"")) || 0;
    return bv - av;
  });

  return list;
}

function renderAllMode(){
  renderList(computeAllList());
}

/* ================= RENDER: WORKSHOPS ================= */
function groupByCraftedAt(){
  const map = new Map();
  for (const r of state.craftingRows){
    const k = r.craftedAt || "Unknown";
    if (!map.has(k)) map.set(k, []);
    map.get(k).push(r);
  }
  // stable ordering by header name
  return [...map.entries()].sort((a,b) => a[0].localeCompare(b[0]));
}

function renderWorkshops(){
  state.view = "workshops";
  dom.filters.style.display = "none";
  dom.search.value = "";
  state.expanded.clear();

  let html = `<div class="view-title">Workshops</div>`;

  const groups = groupByCraftedAt();
  if (!groups.length){
    dom.result.innerHTML = html + `<div class="line">No crafting rows loaded.</div>`;
    return;
  }

  for (const [craftedAt, rows] of groups){
    html += `<div class="section-header">${escapeHtml(craftedAt)}</div>`;
    html += `<table>
      <thead>
        <tr>
          <th>Item Crafted</th>
          <th>Category</th>
          <th>Ingredients</th>
          <th>Workshop Level</th>
        </tr>
      </thead>
      <tbody>`;

    // sort within section by Item Crafted
    rows.sort((a,b) => (a.itemCrafted||"").localeCompare(b.itemCrafted||""));

    for (const r of rows){
      const ings = [r.ing1, r.ing2, r.ing3].filter(Boolean).map(escapeHtml).join("<br>");
      html += `<tr>
        <td>${escapeHtml(r.itemCrafted)}</td>
        <td>${escapeHtml(r.category)}</td>
        <td>${ings || ""}</td>
        <td>${escapeHtml(r.level)}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
  }

  dom.result.innerHTML = html;
}

/* ================= RENDER: SEARCH ================= */
function renderSearch(q){
  const query = norm(q);
  dom.result.innerHTML = "";
  if (!query) return;

  const matches = state.items.filter(it => it.key.includes(query));
  if (!matches.length){
    dom.result.innerHTML = `<div class="line">No match</div>`;
    return;
  }

  // prefix first, then alpha
  matches.sort((a,b) => {
    const ap = a.key.startsWith(query) ? 0 : 1;
    const bp = b.key.startsWith(query) ? 0 : 1;
    if (ap !== bp) return ap - bp;
    return a.name.localeCompare(b.name);
  });

  renderList(matches);
}

/* ================= EVENTS ================= */
dom.search.addEventListener("input", () => {
  state.view = "search";
  dom.filters.style.display = "none";
  renderSearch(dom.search.value);
});

dom.search.addEventListener("focus", () => {
  // entering search should leave other modes
  if (state.view !== "search"){
    state.view = "search";
    dom.filters.style.display = "none";
    dom.result.innerHTML = "";
  }
});

dom.clear.addEventListener("click", () => {
  dom.search.value = "";
  dom.search.focus();
  dom.filters.style.display = "none";
  dom.result.innerHTML = "";
});

dom.showAll.addEventListener("click", () => {
  state.view = "all";
  state.filter = "__other__";          // default = Everything else
  setActiveFilterButton(state.filter);
  dom.filters.style.display = "flex";
  dom.search.value = "";
  state.expanded.clear();
  renderAllMode();
});

dom.filters.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-filter]");
  if (!btn) return;
  state.filter = btn.dataset.filter || "__other__";
  setActiveFilterButton(state.filter);
  state.expanded.clear();
  renderAllMode();
});

dom.workshops.addEventListener("click", () => {
  renderWorkshops();
});

dom.result.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-toggle]");
  if (!btn) return;
  const key = btn.dataset.toggle || "";
  if (!key) return;

  if (state.expanded.has(key)) state.expanded.delete(key);
  else state.expanded.add(key);

  if (state.view === "all") renderAllMode();
  else if (state.view === "search") renderSearch(dom.search.value);
  // Workshops view does not use Full Info toggles.
});

/* ================= BOOT ================= */
(async function init(){
  try{
    setStatus("Loading…", "loading");
    await loadItems();
    await loadCrafting();

    setStatus("Loaded", "loaded");
    setTimeout(() => {
      if (dom.status.classList.contains("loaded")) dom.status.textContent = "";
    }, 5000);

  }catch(err){
    console.error(err);
    setStatus("Error loading data", "error");

    // Explicit visible error (requested) if main items fail to load.
    dom.result.innerHTML =
      `<div class="line" style="color:#ff9933;"><strong>[LOAD ERROR]</strong> Main items did not load. Check the Items CSV tab publishing and the Enabled column.</div>`;
  }
})();
</script>

</body>
</html>

