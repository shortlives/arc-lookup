<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Segoe UI, sans-serif;
      padding:20px;
      max-width:980px;
      margin:0 auto;
    }

    /* ================= TOP BAR ================= */
    .top-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .top-buttons {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .top-buttons a,
    .top-buttons button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 12px;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
    }
    .top-buttons a:hover,
    .top-buttons button:hover { background:#333; }

    .status {
      font-size:12px;
      font-weight:bold;
      white-space:nowrap;
    }
    .status.loading { color:#ff5555; }
    .status.loaded  { color:#33cc66; }
    .status.warn    { color:#ffcc66; }
    .status.error   { color:#ff9933; }

    /* ================= SEARCH ================= */
    .search-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }

    #search {
      flex:1;
      font-size:22px;
      padding:12px;
    }

    #clear-search {
      padding:10px 14px;
      font-size:18px;
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      cursor:pointer;
    }
    #clear-search:hover { background:#333; }

    /* ================= CATEGORY FILTERS ================= */
    .filters {
      display:none;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 14px 0;
    }

    .filters button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
    }

    .filters button.active {
      background:#444;
      border-color:#888;
    }

    /* ================= ITEMS ================= */
    .item-block { margin:10px 0 16px 0; }

    .item-title {
      font-size:26px;
      font-weight:bold;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .item-title a { text-decoration:none; }
    .item-value { font-size:20px; }

    .btn-small {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }

    .notes {
      color:#ff6666;
      margin:6px 0;
      font-size:16px;
    }

    .line { margin:4px 0; font-size:18px; }
    .line-small { font-size:14px; color:#ccc; }

    .quest-tag {
      color:#ffd700;
      font-size:16px;
      margin-left:6px;
    }

    hr { border:1px solid #333; margin:10px 0; }
  </style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit"
       target="_blank">Spreadsheet</a>
    <button id="showAllBtn">Show All (High → Low)</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<!-- Category filters (Show All only) -->
<div class="filters" id="filters">
  <button data-cat="all" class="active">All</button>
  <button data-cat="Weapon">Weapon</button>
  <button data-cat="Modification">Modification</button>
  <button data-cat="Blueprint">Blueprint</button>
  <button data-cat="Key">Key</button>
  <button data-cat="Quest Item">Quest Item</button>
  <button data-cat="Misc">Misc</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG
   ============================================================
   2025-12-15
   - Switched data source to dedicated CSV export tab (gid=1167907621)
     Reason: eliminate column drift & silent row drops from mixed-content sheets.
   - Restored category filter buttons ONLY inside Show All view.
     Reason: requested UX, but enforced exclusive view to avoid state explosions.
   - Refactored rendering to a single pipeline:
       getVisibleItems() -> renderListChunked()
     Reason: DRY, prevents desync bugs and browser freezes.
   - Kept chunked rendering + CSV normalization.
     Reason: performance and data integrity.
*/

/* ================= CONFIG ================= */
const ITEMS_MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

/* ================= DOM ================= */
const dom = {
  status: document.getElementById("status"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  showAll: document.getElementById("showAllBtn"),
  filters: document.getElementById("filters"),
  result: document.getElementById("result")
};

/* ================= STATE ================= */
const state = {
  items: [],
  view: "search",        // search | all
  activeCategory: "all", // category filter (Show All only)
  expanded: new Set()
};

/* ================= CSV ================= */
function parseCsv(text) {
  const rows = [];
  let row = [], field = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];
    if (c === '"' && inQuotes && n === '"') { field += '"'; i++; }
    else if (c === '"') inQuotes = !inQuotes;
    else if (c === "," && !inQuotes) { row.push(field); field = ""; }
    else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (row.length || field) rows.push([...row, field]);
      row = []; field = "";
    } else field += c;
  }
  if (row.length || field) rows.push([...row, field]);
  return rows;
}

/* ================= LOAD ================= */
async function loadItems() {
  const res = await fetch(ITEMS_MASTER_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV fetch failed");

  const rows = parseCsv(await res.text());
  const headers = rows.shift().map(h => h.toLowerCase());
  rows.shift(); // config row

  const idx = h => headers.indexOf(h);

  state.items = rows
    .filter(r => r[idx("name")])
    .filter(r => (r[idx("enabled")] || "").toLowerCase() !== "false")
    .map(r => ({
      name: r[idx("name")],
      nameKey: r[idx("name")].toLowerCase(),
      rarity: r[idx("rarity")],
      value: Number(r[idx("value")] || 0),
      apiId: r[idx("apiid")],
      category: r[idx("itemtype")] || "Misc"
    }));
}

/* ================= HELPERS ================= */
function rarityColor(r) {
  r = (r || "").toLowerCase();
  if (r.includes("legendary")) return "#ffd700";
  if (r.includes("epic")) return "#ff00ff";
  if (r.includes("rare")) return "#00bfff";
  if (r.includes("uncommon")) return "#00ff00";
  return "#ffffff";
}

/* ================= RENDER ================= */
function getVisibleItems() {
  let list = [...state.items];

  if (state.view === "search") {
    const q = dom.search.value.trim().toLowerCase();
    if (!q) return [];
    list = list.filter(it => it.nameKey.includes(q));
  }

  if (state.view === "all") {
    list.sort((a,b) => b.value - a.value);
    if (state.activeCategory !== "all") {
      list = list.filter(it => it.category === state.activeCategory);
    }
  }

  return list;
}

function renderListChunked(items, batch = 25) {
  dom.result.innerHTML = "";
  let i = 0;

  function chunk() {
    const slice = items.slice(i, i + batch).map(it => `
      <div class="item-block">
        <div class="item-title">
          <a href="https://metaforge.app/arc-raiders/database/item/${encodeURIComponent(it.apiId)}" target="_blank">
            <span style="color:${rarityColor(it.rarity)}">${it.name}</span>
          </a>
          <span class="item-value">— ${it.value}</span>
        </div>
        <hr>
      </div>
    `).join("");

    dom.result.insertAdjacentHTML("beforeend", slice);
    i += batch;
    if (i < items.length) requestAnimationFrame(chunk);
  }

  if (!items.length) {
    dom.result.innerHTML = `<div class="line">No match</div>`;
    return;
  }

  requestAnimationFrame(chunk);
}

function render() {
  renderListChunked(getVisibleItems());
}

/* ================= EVENTS ================= */
dom.search.addEventListener("input", () => {
  state.view = "search";
  dom.filters.style.display = "none";
  render();
});

dom.clear.addEventListener("click", () => {
  dom.search.value = "";
  dom.result.innerHTML = "";
});

dom.showAll.addEventListener("click", () => {
  state.view = "all";
  state.activeCategory = "all";
  dom.search.value = "";
  dom.filters.style.display = "flex";
  [...dom.filters.children].forEach(b => b.classList.remove("active"));
  dom.filters.querySelector('[data-cat="all"]').classList.add("active");
  render();
});

dom.filters.addEventListener("click", e => {
  const btn = e.target.closest("button[data-cat]");
  if (!btn) return;

  state.activeCategory = btn.dataset.cat;
  [...dom.filters.children].forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  render();
});

/* ================= BOOT ================= */
(async function init() {
  try {
    await loadItems();
    dom.status.textContent = "Loaded";
    dom.status.className = "status loaded";
  } catch (e) {
    console.error(e);
    dom.status.textContent = "Error loading data";
    dom.status.className = "status error";
  }
})();
</script>

</body>
</html>
