<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <!-- MetaForge tooltips -->
  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      font-family:Segoe UI, sans-serif;
      padding:20px;
      max-width:980px;
      margin:0 auto;
    }

    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }

    .top-buttons {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .top-buttons a,
    .top-buttons button {
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      padding:6px 12px;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
    }

    .top-buttons a:hover,
    .top-buttons button:hover {
      background:#333;
    }

    .status {
      font-size:12px;
      font-weight:bold;
    }
    .status.loading { color:#ff5555; }
    .status.loaded  { color:#33cc66; }
    .status.error   { color:#ff9933; }

    .search-row {
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }

    #search {
      flex:1;
      font-size:22px;
      padding:12px;
    }

    #clear-search {
      font-size:18px;
      padding:10px 14px;
      background:#222;
      color:#fff;
      border:1px solid #444;
      border-radius:6px;
      cursor:pointer;
    }

    .instructions {
      display:none;
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      padding:10px 12px;
      font-size:13px;
      margin-bottom:12px;
    }

    .item-block {
      margin:10px 0 16px 0;
    }

    .item-title {
      font-size:26px;
      font-weight:bold;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .item-title a {
      text-decoration:none;
    }

    .item-value {
      font-size:20px;
    }

    hr {
      border:1px solid #333;
      margin:10px 0;
    }
  </style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank" rel="noopener noreferrer">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit?gid=491619272"
       target="_blank" rel="noopener noreferrer">Spreadsheet</a>
    <button id="showAllBtn" type="button">Show All (High → Low)</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search" type="button">×</button>
</div>

<div id="instructions" class="instructions">
  Start typing to search items.
</div>

<div id="result"></div>

<script>
"use strict";

/* ================= CONFIG ================= */
const ITEMS_MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=491619272&single=true&output=csv";

const VIEWS = {
  SEARCH: "search",
  ALL: "all"
};

/* ================= DOM ================= */
const dom = {
  status: document.getElementById("status"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  showAll: document.getElementById("showAllBtn"),
  result: document.getElementById("result"),
  instructions: document.getElementById("instructions")
};

/* ================= STATE ================= */
const state = {
  view: VIEWS.SEARCH,
  items: []
};

/* ================= CSV PARSER ================= */
function parseCsv(text) {
  const rows = [];
  let row = [];
  let field = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const n = text[i + 1];

    if (c === '"' && inQuotes && n === '"') {
      field += '"';
      i++;
    } else if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      row.push(field);
      field = "";
    } else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (row.length || field) rows.push([...row, field]);
      row = [];
      field = "";
    } else {
      field += c;
    }
  }

  if (row.length || field) rows.push([...row, field]);
  return rows;
}

/* ================= LOAD ================= */
async function loadItems() {
  const res = await fetch(ITEMS_MASTER_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV fetch failed");

  const rows = parseCsv(await res.text());
  const headers = rows.shift().map(h => h.toLowerCase());
  rows.shift(); // config row

  const idx = h => headers.indexOf(h);

  state.items = rows
    .filter(r => r[idx("name")])
    .filter(r => (r[idx("enabled")] || "").toLowerCase() !== "false")
    .map(r => ({
      name: r[idx("name")],
      nameKey: r[idx("name")].toLowerCase(),
      rarity: r[idx("rarity")],
      value: Number(r[idx("value")] || 0),
      apiId: r[idx("apiid")]
    }));
}

/* ================= HELPERS ================= */
function rarityColor(r) {
  r = (r || "").toLowerCase();
  if (r.includes("legendary")) return "#ffd700";
  if (r.includes("epic")) return "#ff00ff";
  if (r.includes("rare")) return "#00bfff";
  if (r.includes("uncommon")) return "#00ff00";
  return "#ffffff";
}

function renderItems(items) {
  dom.result.innerHTML = items.map(it => `
    <div class="item-block">
      <div class="item-title">
        <a href="https://metaforge.app/arc-raiders/database/item/${encodeURIComponent(it.apiId)}"
           target="_blank" rel="noopener noreferrer">
          <span style="color:${rarityColor(it.rarity)}">${it.name}</span>
        </a>
        <span class="item-value">— ${it.value}</span>
      </div>
      <hr>
    </div>
  `).join("");
}

/* ================= RENDER ================= */
function render() {
  dom.result.innerHTML = "";

  if (state.view === VIEWS.ALL) {
    dom.instructions.style.display = "none";
    renderItems([...state.items].sort((a,b) => b.value - a.value));
    return;
  }

  const q = dom.search.value.trim().toLowerCase();
  dom.instructions.style.display = q ? "none" : "block";
  if (!q) return;

  renderItems(
    state.items
      .filter(it => it.nameKey.includes(q))
      .sort((a,b) => a.name.localeCompare(b.name))
  );
}

/* ================= EVENTS ================= */
dom.showAll.addEventListener("click", () => {
  state.view = VIEWS.ALL;
  dom.search.value = "";
  render();
});

dom.search.addEventListener("input", () => {
  state.view = VIEWS.SEARCH;
  render();
});

dom.clear.addEventListener("click", () => {
  dom.search.value = "";
  state.view = VIEWS.SEARCH;
  dom.result.innerHTML = "";
  dom.instructions.style.display = "block";
});

/* ================= BOOT ================= */
(async function init() {
  try {
    await loadItems();
    dom.status.textContent = "Loaded";
    dom.status.className = "status loaded";
  } catch (err) {
    console.error(err);
    dom.status.textContent = "Error loading data";
    dom.status.className = "status error";
  }
})();
</script>

</body>
</html>
