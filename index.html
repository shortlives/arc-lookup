<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARC Lookup</title>

  <script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

  <style>
    body{
      background:#000; color:#fff; font-family:Segoe UI,sans-serif;
      padding:20px; max-width:1100px; margin:0 auto;
    }

    .top-bar{
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; margin-bottom:12px;
    }
    .top-buttons{ display:flex; gap:10px; flex-wrap:wrap; }
    .top-buttons a,.top-buttons button{
      background:#222; color:#fff; border:1px solid #444;
      border-radius:6px; padding:6px 12px; cursor:pointer;
      text-decoration:none;
    }

    .status.loading{ color:#ff5555; }
    .status.loaded{ color:#33cc66; }
    .status.error{ color:#ff9933; }

    .search-row{ display:flex; gap:8px; margin-bottom:10px; }
    #search{ flex:1; font-size:22px; padding:12px; }
    #clear-search{ font-size:18px; padding:10px 14px; }

    .instructions{ display:none; font-size:13px; margin-bottom:10px; color:#ccc; }

    .item-block{ margin:12px 0 18px 0; }
    .item-title{ font-size:26px; font-weight:bold; display:flex; gap:10px; flex-wrap:wrap; }
    .item-value{ font-size:20px; }
    .line{ margin:4px 0; font-size:18px; }
    .btn-small{
      background:#222; border:1px solid #444;
      color:#fff; padding:4px 10px; border-radius:6px;
      cursor:pointer;
    }
    hr{ border:1px solid #333; margin:12px 0; }

    /* Workshops table */
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{
      border-bottom:1px solid #333;
      padding:10px 8px;
      vertical-align:top;
    }
    th{ text-align:left; color:#ffd700; }
    tr{ line-height:1.4; }
    .section-header{
      margin-top:24px;
      font-size:24px;
      font-weight:bold;
      border-bottom:1px solid #444;
      padding-bottom:6px;
    }
  </style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit"
       target="_blank">Spreadsheet</a>
    <button id="workshopsBtn">Workshops</button>
    <button id="showAllBtn">Show All</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<div id="instructions" class="instructions">
  Type to search items. Click Workshops to browse crafting.
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-15
   - FIXED: Header normalization regression.
   - RESTORED: Spreadsheet button and full item info.
   - ADDED: Filters and Everything Else category.

   2025-12-16
   - ADDED: Crafting system and Workshops view.
   - ADDED: Reverse crafting lookup ("Crafts To").

   2025-12-17
   - FIXED: Search rendering pipeline was disconnected.
     Root cause: items were loading but never rendered.
   - ADDED: Hard error if zero items load from Items CSV.
   - CHANGED: Workshops view converted to table layout
     for readability and spacing.
*/

/* ============================================================
   CONFIG
   ============================================================ */
const ITEMS_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ============================================================
   STATE
   ============================================================ */
const state = {
  items: [],
  crafting: [],
  craftsByIngredient: new Map(),
  viewMode: "search"
};

/* ============================================================
   HELPERS
   ============================================================ */
const dom = {
  result: document.getElementById("result"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  status: document.getElementById("status"),
  instructions: document.getElementById("instructions"),
  workshopsBtn: document.getElementById("workshopsBtn"),
  showAllBtn: document.getElementById("showAllBtn")
};

function canon(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]/g,""); }
function norm(s){ return (s||"").trim().toLowerCase(); }

function parseCsv(text){
  const rows=[]; let row=[], field="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'&&q&&n==='"'){ field+='"'; i++; }
    else if(c==='"'){ q=!q; }
    else if(c===','&&!q){ row.push(field); field=""; }
    else if((c==='\n'||c==='\r')&&!q){
      if(row.length||field) rows.push([...row,field]);
      row=[]; field="";
    } else field+=c;
  }
  if(row.length||field) rows.push([...row,field]);
  return rows;
}

function parseQtyName(entry){
  if(!entry) return null;
  const m=entry.match(/^(\d+)\s*x?\s*(.+)$/i);
  return m ? {qty:+m[1], name:m[2]} : {qty:null,name:entry};
}

/* ============================================================
   LOADERS
   ============================================================ */
async function loadCsv(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("CSV load failed");
  return parseCsv(await r.text());
}

async function loadItems(){
  const rows=await loadCsv(ITEMS_CSV);
  const headers=rows.shift().map(canon);
  rows.shift(); // config row

  const idx=h=>headers.indexOf(canon(h));

  state.items = rows
    .filter(r=>r[idx("name")])
    .map(r=>({
      name:r[idx("name")],
      nameKey:norm(r[idx("name")]),
      value:r[idx("value")]||"",
      recycle:[r[idx("recycle1")],r[idx("recycle2")]].filter(Boolean)
    }));

  if(state.items.length === 0){
    throw new Error("Items CSV loaded but contained 0 usable items.");
  }
}

async function loadCrafting(){
  const rows=await loadCsv(CRAFTING_CSV);
  const headers=rows.shift().map(canon);
  const idx=h=>headers.indexOf(canon(h));

  state.crafting=[];
  state.craftsByIngredient.clear();

  for(const r of rows){
    const crafted=r[idx("itemcrafted")];
    if(!crafted) continue;

    const ingredients=[1,2,3]
      .map(n=>r[idx(`ingredient${n}`)])
      .filter(Boolean)
      .map(parseQtyName);

    const row={
      crafted,
      category:r[idx("category")]||"",
      at:r[idx("craftedat")]||"",
      level:r[idx("level")]||"",
      ingredients
    };
    state.crafting.push(row);

    for(const ing of ingredients){
      const k=norm(ing.name);
      if(!state.craftsByIngredient.has(k))
        state.craftsByIngredient.set(k,[]);
      state.craftsByIngredient.get(k).push(row);
    }
  }
}

/* ============================================================
   RENDERING
   ============================================================ */
function renderItem(item){
  return `
    <div class="item-block">
      <div class="item-title">
        ${item.name}
        ${item.value ? `<span class="item-value">— ${item.value}</span>` : ""}
      </div>
      ${renderCraftsTo(item)}
      <hr>
    </div>`;
}

function renderCraftsTo(item){
  const list=state.craftsByIngredient.get(item.nameKey);
  if(!list||!list.length) return "";
  return `<div class="line"><strong>Crafts To:</strong> ${
    list.map(c=>c.crafted).join(", ")
  }</div>`;
}

function renderSearch(q){
  const matches=state.items.filter(i=>i.nameKey.includes(q));
  dom.result.innerHTML = matches.length
    ? matches.map(renderItem).join("")
    : "<div class='line'>No match</div>";
}

function renderWorkshops(){
  dom.result.innerHTML="";
  const groups={};
  for(const c of state.crafting){
    if(!groups[c.at]) groups[c.at]=[];
    groups[c.at].push(c);
  }

  for(const at of Object.keys(groups)){
    dom.result.insertAdjacentHTML("beforeend",`
      <div class="section-header">${at}</div>
      <table>
        <tr>
          <th>Item Crafted</th>
          <th>Category</th>
          <th>Ingredients</th>
          <th>Workshop Level</th>
        </tr>
        ${groups[at].map(c=>`
          <tr>
            <td>${c.crafted}</td>
            <td>${c.category}</td>
            <td>${c.ingredients.map(i=>`${i.name} ×${i.qty||1}`).join(", ")}</td>
            <td>${c.level||""}</td>
          </tr>
        `).join("")}
      </table>
    `);
  }
}

/* ============================================================
   EVENTS
   ============================================================ */
dom.search.oninput=()=>{
  state.viewMode="search";
  dom.instructions.style.display="block";
  renderSearch(norm(dom.search.value));
};

dom.clear.onclick=()=>{
  dom.search.value="";
  dom.result.innerHTML="";
};

dom.workshopsBtn.onclick=()=>{
  state.viewMode="workshops";
  dom.instructions.style.display="none";
  renderWorkshops();
};

/* ============================================================
   BOOT
   ============================================================ */
(async()=>{
  try{
    await loadItems();
    await loadCrafting();
    dom.status.textContent="Loaded";
    dom.status.className="status loaded";
  }catch(e){
    console.error(e);
    dom.status.textContent="ERROR: Items failed to load";
    dom.status.className="status error";
    dom.result.innerHTML="<div class='line'>Fatal error loading item data.</div>";
  }
})();
</script>

</body>
</html>
