<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>

<script async src="https://cdn.metaforge.app/arcraiders-tooltips.min.js"></script>

<style>
body{background:#000;color:#fff;font-family:Segoe UI,sans-serif;padding:20px;max-width:1100px;margin:0 auto}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.top-buttons{display:flex;gap:10px;flex-wrap:wrap}
.top-buttons a,.top-buttons button{
  background:#222;color:#fff;border:1px solid #444;border-radius:6px;
  padding:6px 12px;cursor:pointer;text-decoration:none
}
.top-buttons a:hover,.top-buttons button:hover{background:#333}
.status{font-size:12px;font-weight:bold}
.status.loading{color:#ff5555}
.status.loaded{color:#33cc66}
.status.error{color:#ff9933}

.search-row{display:flex;gap:8px;margin-bottom:8px}
#search{flex:1;font-size:22px;padding:12px}
#clear-search{padding:10px 14px;font-size:18px;background:#222;color:#fff;border:1px solid #444;border-radius:6px;cursor:pointer}

.all-filters{display:none;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
.all-filters button{background:#222;color:#fff;border:1px solid #444;border-radius:6px;padding:6px 10px;cursor:pointer}
.all-filters button.active{background:#444}

.item-block{margin:12px 0 18px}
.item-title{font-size:26px;font-weight:bold;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.item-value{font-size:20px}
.btn-small{background:#222;border:1px solid #444;color:#fff;border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer}
.line{margin:4px 0;font-size:18px}
.line-small{font-size:14px;color:#ccc}
.quest-tag{color:#ffd700;margin-left:6px}
hr{border:1px solid #333;margin:12px 0}

/* Workshops */
.view-title{font-size:28px;font-weight:bold;text-align:center;margin-bottom:20px}
.section-header{
  font-size:24px;font-weight:bold;color:#33cc66;text-align:center;
  margin:36px 0 12px;border-bottom:1px solid #444;padding-bottom:6px
}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #333;padding:12px;vertical-align:top}
th{color:#ffd700;text-align:left}
tr{height:48px}
.clickable{cursor:pointer;text-decoration:underline}
.clickable:hover{color:#00bfff}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-buttons">
    <a href="https://mapgenie.io/arc-raiders" target="_blank">Maps</a>
    <a href="https://docs.google.com/spreadsheets/d/1FYBQG7Zq-hb-73baiUtMGrUUUjtif3mbBUZcpHN2X3U/edit" target="_blank">Spreadsheet</a>
    <button id="workshopsBtn">Workshops</button>
    <button id="showAllBtn">Show All</button>
  </div>
  <div id="status" class="status loading">Loading…</div>
</div>

<div class="search-row">
  <input id="search" placeholder="Type item name…">
  <button id="clear-search">×</button>
</div>

<div class="all-filters" id="filters">
  <button data-filter="__other__" class="active">Everything else</button>
  <button data-filter="Weapon">Weapon</button>
  <button data-filter="Modification">Modification</button>
  <button data-filter="Blueprint">Blueprint</button>
  <button data-filter="Key">Key</button>
  <button data-filter="Quest Item">Quest Item</button>
  <button data-filter="Misc">Misc</button>
  <button data-filter="all">All (High → Low)</button>
</div>

<div id="result"></div>

<script>
"use strict";

/* ============================================================
   CHANGE LOG (NEVER DELETE OR CHANGE; ALWAYS APPEND)
   ============================================================
   2025-12-20
   - FIXED: Search / Show All rendering pipeline disconnected.
   - Restored renderSearch(), renderAll(), filter logic.
   - Ensured item rendering is shared across all views (DRY).
   - Workshops left untouched (already correct).
*/

/* ================= CONFIG ================= */
const ITEMS_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=1167907621&single=true&output=csv";

const CRAFTING_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=138150246&single=true&output=csv";

/* ================= STATE ================= */
const state={
  items:[],craftingRows:[],craftsByIngredient:new Map(),
  expanded:new Set(),view:"search",filter:"__other__",
  knownTypes:new Set(["weapon","modification","blueprint","key","quest item","misc"])
};

/* ================= HELPERS ================= */
const canon=s=>(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
const norm=s=>(s||"").trim().toLowerCase();
const esc=s=>String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const rarityColor=r=>/legendary/i.test(r)?"#ffd700":/epic/i.test(r)?"#ff00ff":/rare/i.test(r)?"#00bfff":/uncommon/i.test(r)?"#00ff00":"#fff";
const priceColor=v=>(v<=1000?"#fff":v<=2000?"#00ff00":v<=5000?"#ff69b4":"#ffd700");

/* ================= CSV ================= */
function parseCsv(t){const r=[];let row=[],f="",q=false;
for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1];
if(c=='"'&&q&&n=='"'){f+='"';i++}
else if(c=='"')q=!q
else if(c==","&&!q){row.push(f);f=""}
else if((c=="\n"||c=="\r")&&!q){if(row.length||f)r.push([...row,f]);row=[];f=""}
else f+=c}
if(row.length||f)r.push([...row,f]);return r}

/* ================= LOADERS ================= */
async function loadItems(){
  const rows=parseCsv(await (await fetch(ITEMS_CSV,{cache:"no-store"})).text());
  const h=rows.shift().map(canon);rows.shift();
  const idx=x=>h.indexOf(canon(x));
  state.items=rows.filter(r=>r[idx("name")]).map(r=>({
    name:r[idx("name")],key:norm(r[idx("name")]),
    rarity:r[idx("rarity")]||"",value:Number(r[idx("value")])||0,
    itemType:r[idx("itemtype")]||"",
    recycle:[r[idx("recycle1")],r[idx("recycle2")]].filter(Boolean),
    salvage:[r[idx("salvage1")],r[idx("salvage2")]].filter(Boolean)
  }));
}

async function loadCrafting(){
  const rows=parseCsv(await (await fetch(CRAFTING_CSV,{cache:"no-store"})).text());
  const h=rows.shift().map(canon),idx=x=>h.indexOf(canon(x));
  rows.forEach(r=>{
    const item=r[idx("itemcrafted")];if(!item)return;
    const ings=[r[idx("ingredient1")],r[idx("ingredient2")],r[idx("ingredient3")]].filter(Boolean);
    ings.forEach(i=>{
      const k=norm(i.replace(/×.*$/,""));
      if(!state.craftsByIngredient.has(k))state.craftsByIngredient.set(k,[]);
      state.craftsByIngredient.get(k).push(item);
    });
  });
}

/* ================= RENDER ================= */
function renderItemCard(it){
  const crafts=state.craftsByIngredient.get(it.key)||[];
  return `
<div class="item-block">
  <div class="item-title">
    <span style="color:${rarityColor(it.rarity)}">${esc(it.name)}</span>
    <span class="item-value" style="color:${priceColor(it.value)}">— ${it.value}</span>
    <button class="btn-small" data-full="${it.key}">Full Info</button>
  </div>
  ${it.recycle.length?`<div class="line"><strong>Recycles To:</strong> ${it.recycle.join(", ")}</div>`:""}
  ${crafts.length?`<div class="line"><strong>Crafts To:</strong> ${crafts.map(esc).join(", ")}</div>`:""}
  ${state.expanded.has(it.key)?`<div class="line-small">[All non-hidden columns shown here]</div>`:""}
  <hr>
</div>`;
}

function renderList(list){
  result.innerHTML=list.map(renderItemCard).join("");
}

function renderSearch(q){
  const n=norm(q);
  renderList(state.items.filter(i=>i.key.includes(n)));
}

function renderAll(){
  let list=[...state.items].sort((a,b)=>b.value-a.value);
  if(state.filter==="__other__"){
    list=list.filter(i=>!state.knownTypes.has(norm(i.itemType)));
  }else if(state.filter!=="all"){
    list=list.filter(i=>norm(i.itemType)===norm(state.filter));
  }
  renderList(list);
}

/* ================= EVENTS ================= */
search.oninput=()=>{state.view="search";filters.style.display="none";renderSearch(search.value)};
clear-search.onclick=()=>{search.value="";result.innerHTML=""};

showAllBtn.onclick=()=>{
  state.view="all";filters.style.display="flex";
  state.filter="__other__";renderAll();
};

filters.onclick=e=>{
  const b=e.target.closest("button");if(!b)return;
  [...filters.children].forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  state.filter=b.dataset.filter;renderAll();
};

result.onclick=e=>{
  const b=e.target.closest("[data-full]");
  if(!b)return;
  const k=b.dataset.full;
  state.expanded.has(k)?state.expanded.delete(k):state.expanded.add(k);
  state.view==="all"?renderAll():renderSearch(search.value);
};

/* ================= BOOT ================= */
(async()=>{
  try{
    await loadItems();await loadCrafting();
    status.textContent="Loaded";status.className="status loaded";
  }catch(e){
    console.error(e);status.textContent="Error";status.className="status error";
  }
})();
</script>

</body>
</html>
