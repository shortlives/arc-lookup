<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ARC Lookup</title>
<style>
  body {
    background:#000;
    color:#fff;
    font-family:Segoe UI, sans-serif;
    padding:20px;
  }
  input, button {
    font-size:22px;
    padding:12px;
    width:95%;
    margin-bottom:15px;
  }
  .item-name {
    font-size:26px;
    font-weight:bold;
  }
  .line {
    margin:4px 0;
    font-size:18px;
  }
  .section-header {
    margin:10px 0 4px 0;
    font-size:20px;
    font-weight:bold;
    color:#ffa500;
  }
  hr {
    border:1px solid #333;
    margin:10px 0;
  }
</style>
</head>
<body>

<input id="search" placeholder="Type item name..." autofocus>
<div id="result"></div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?output=csv";

const data = [];

fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const rows = text.replace(/\r/g,"").split("\n");
    rows.shift(); // remove header row

    for (let r of rows) {
      if (!r.trim()) continue;
      const f = csvSplit(r);
      data.push({
        name:      f[0] || "",
        rarity:    f[1] || "",
        recycle1:  f[2] || "",
        recycle2:  f[3] || "",
        sellPrice: f[4] || "",
        category:  f[5] || "",
        keep1:     f[6] || "",
        keep2:     f[7] || "",
        keep3:     f[8] || "",
        notes:     f[9] || ""
      });
    }
});

function csvSplit(row) {
  let out = [], field = "", q = false;
  for (const ch of row) {
    if (ch === '"') { q = !q; continue; }
    if (ch === ',' && !q) { out.push(field); field = ""; continue; }
    field += ch;
  }
  out.push(field);
  return out;
}

// Strip "2x " patterns to match names
function extractItemNameFromRecycle(str) {
  return str.replace(/^\s*\d+\s*x\s*/i, "").trim();
}

/* ===== FAST SEARCH ===== */
let timer = null;
document.getElementById("search").addEventListener("input", function () {
  clearTimeout(timer);
  const q = this.value.trim();
  timer = setTimeout(() => runSearch(q), 100);
});

function runSearch(query) {
  const q = query.toLowerCase();
  const out = document.getElementById("result");
  out.innerHTML = "";
  if (!q) return;

  const matches = data.filter(d => d.name.toLowerCase().includes(q));
  if (!matches.length) {
    out.innerHTML = "<div>No match</div>";
    return;
  }

  let html = "";

  // ========== MAIN ITEM CARDS ==========
  matches.forEach(item => {
    const rarity = (item.rarity || "").toLowerCase();
    let nameColor = "white";

    if (rarity.includes("uncommon")) nameColor = "#00ff00";
    else if (rarity.includes("rare")) nameColor = "#1e90ff";
    else if (rarity.includes("epic")) nameColor = "#ff00ff";
    else if (rarity.includes("legendary")) nameColor = "#ffd700";

    const priceNum = parseInt((item.sellPrice || "").replace(/[^0-9]/g,"")) || 0;
    let priceColor = "white";

    if (priceNum >= 1000 && priceNum <= 2000) priceColor = "#00ff00";
    else if (priceNum >= 2001 && priceNum <= 5000) priceColor = "#ff69b4";
    else if (priceNum >= 5001) priceColor = "#ffd700";

    const recycleParts = [];
    if (item.recycle1) recycleParts.push(item.recycle1);
    if (item.recycle2) recycleParts.push(item.recycle2);

    // Combine Quest fields into one line
    const questParts = [];
    if (item.keep1) questParts.push(item.keep1);
    if (item.keep2) questParts.push(item.keep2);
    if (item.keep3) questParts.push(item.keep3);

    html += `
      <div class="item-name" style="color:${nameColor}">${item.name}</div>
      ${item.rarity ? `<div class="line">Rarity: ${item.rarity}</div>` : ""}
      ${item.category ? `<div class="line">Category: ${item.category}</div>` : ""}
      ${item.sellPrice ? `<div class="line" style="color:${priceColor}; font-weight:bold;">Sell Price: ${item.sellPrice}</div>` : ""}
      ${recycleParts.length ? `<div class="line">Recycles To: ${recycleParts.join(", ")}</div>` : ""}
      ${questParts.length ? `<div class="line">Quest: ${questParts.join(", ")}</div>` : ""}
      ${item.notes ? `<div class="line">Notes: ${item.notes}</div>` : ""}
      <hr>
    `;
  });

  // ========== REVERSE RECYCLE LOOKUP ==========
  const exact = data.find(d => d.name.toLowerCase() === q);
  const targetName = exact ? exact.name : matches[0].name;
  const targetNameLower = targetName.toLowerCase();

  const recyclers = data.filter(d => {
    if (!d.recycle1 && !d.recycle2) return false;

    const r1 = extractItemNameFromRecycle(d.recycle1 || "").toLowerCase();
    const r2 = extractItemNameFromRecycle(d.recycle2 || "").toLowerCase();

    const givesTarget = (r1 === targetNameLower || r2 === targetNameLower);
    const isSameItem = d.name.toLowerCase() === targetNameLower;

    return givesTarget && !isSameItem;
  });

  if (recyclers.length) {
    html += `<div class="section-header">Items that recycle into ${targetName}:</div>`;
    recyclers.forEach(src => {
      html += `
        <div class="line">â€¢ ${src.name}</div>
      `;
    });
  }

  out.innerHTML = html;
}
</script>
</body>
</html>
