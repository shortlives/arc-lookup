<script>
"use strict";

/* ================= CONFIG ================= */
const ITEMS_MASTER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8XIQtZGS9iURh9D5oWsgyyBMqNJkLy9x0olt6DKKlCHevSpZ3qQevYZjrpctOLjOUyDFv1HEjkqGq/pub?gid=491619272&single=true&output=csv";

const VIEWS = {
  SEARCH: "search",
  ALL: "all"
};

/* ================= DOM ================= */
const dom = {
  status: document.getElementById("status"),
  search: document.getElementById("search"),
  clear: document.getElementById("clear-search"),
  showAll: document.getElementById("showAllBtn"),
  result: document.getElementById("result"),
  instructions: document.getElementById("instructions")
};

/* ================= STATE ================= */
const state = {
  view: VIEWS.SEARCH,
  items: []
};

/* ================= CSV ================= */
function parseCsv(text) {
  const rows = [];
  let row = [], field = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];
    if (c === '"' && inQuotes && n === '"') { field += '"'; i++; }
    else if (c === '"') inQuotes = !inQuotes;
    else if (c === "," && !inQuotes) { row.push(field); field = ""; }
    else if ((c === "\n" || c === "\r") && !inQuotes) {
      if (row.length || field) rows.push([...row, field]);
      row = []; field = "";
    } else field += c;
  }
  if (row.length || field) rows.push([...row, field]);
  return rows;
}

/* ================= LOAD ================= */
async function loadItems() {
  const res = await fetch(ITEMS_MASTER_CSV_URL, { cache: "no-store" });
  const rows = parseCsv(await res.text());
  const headers = rows.shift().map(h => h.toLowerCase());
  rows.shift(); // config row

  const idx = h => headers.indexOf(h);

  state.items = rows
    .filter(r => r[idx("enabled")]?.toLowerCase() !== "false")
    .map(r => ({
      name: r[idx("name")],
      nameKey: r[idx("name")]?.toLowerCase() || "",
      rarity: r[idx("rarity")],
      value: Number(r[idx("value")] || 0),
      apiId: r[idx("apiid")]
    }));
}

/* ================= HELPERS ================= */
function rarityColor(r) {
  r = (r || "").toLowerCase();
  if (r.includes("legendary")) return "#ffd700";
  if (r.includes("epic")) return "#ff00ff";
  if (r.includes("rare")) return "#00bfff";
  if (r.includes("uncommon")) return "#00ff00";
  return "#fff";
}

function renderItems(items) {
  dom.result.innerHTML = items.map(it => `
    <div class="item-block">
      <div class="item-title">
        <a href="https://metaforge.app/arc-raiders/database/item/${it.apiId}"
           target="_blank" rel="noopener noreferrer">
          <span style="color:${rarityColor(it.rarity)}">${it.name}</span>
        </a>
        <span class="item-value">â€” ${it.value}</span>
      </div>
      <hr>
    </div>
  `).join("");
}

/* ================= RENDER ================= */
function render() {
  dom.result.innerHTML = "";
  dom.instructions.style.display = state.view === VIEWS.SEARCH ? "block" : "none";

  if (state.view === VIEWS.ALL) {
    const sorted = [...state.items].sort((a, b) => b.value - a.value);
    renderItems(sorted);
    return;
  }

  const q = dom.search.value.trim().toLowerCase();
  if (!q) return;

  const matches = state.items
    .filter(it => it.nameKey.includes(q))
    .sort((a, b) => a.name.localeCompare(b.name));

  renderItems(matches);
}

/* ================= EVENTS ================= */
dom.showAll.onclick = () => {
  state.view = VIEWS.ALL;
  dom.search.value = "";
  render();
};

dom.search.oninput = () => {
  state.view = VIEWS.SEARCH;
  render();
};

dom.clear.onclick = () => {
  dom.search.value = "";
  dom.result.innerHTML = "";
};

/* ================= BOOT ================= */
(async function init() {
  try {
    await loadItems();
    dom.status.textContent = "Loaded";
    dom.status.className = "status loaded";
  } catch (e) {
    console.error(e);
    dom.status.textContent = "Error loading data";
    dom.status.className = "status error";
  }
})();
</script>
